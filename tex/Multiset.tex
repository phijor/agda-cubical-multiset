\documentclass[a4paper,USenglish,cleveref]{lipics-v2021}

\usepackage[debug]{multiset}

\usepackage{bussproofs}

\usepackage{todonotes}

\bibliographystyle{plainurl}

\title{Constructive Final Semantics of Finite Bags}
% \titlerunning{Final Coalgebra of Finite Bags in HoTT}
\author{Philipp Joram}%
  {Department of Software Science, Tallinn University of Technology, Estonia}
  {philipp@cs.ioc.ee}%
  {https://orcid.org/0000-0002-0448-7907}%
  {}
\author{Niccol{\`o} Veltri}%
  {Department of Software Science, Tallinn University of Technology, Estonia}
  {niccolo@cs.ioc.ee}%
  {https://orcid.org/0000-0002-7230-3436}%
  {}

\authorrunning{P. Joram and N. Veltri}
\Copyright{Philipp Joram and Niccol{\`o} Veltri}

\begin{CCSXML}
  <ccs2012>
    <concept>
      <concept_id>10003752.10003790.10011740</concept_id>
      <concept_desc>Theory of computation~Type theory</concept_desc>
      <concept_significance>500</concept_significance>
    </concept>
  </ccs2012>
\end{CCSXML}

\ccsdesc[500]{Theory of computation~Type theory\todo{Use proper classification.}}

\acknowledgements{%
  This work was supported by the Estonian Research Council grant PSG749.
}

\begin{document}

\maketitle

\begin{abstract}
  Finitely-branching and unlabelled dynamical systems are typically modelled as coalgebras for the finite powerset functor.
  If states are reachable in multiple ways, coalgebras for the finite bag functor provide a more faithful representation.
  The final coalgebra of this functor is employed as a denotational domain for the evaluation of such systems.
  Elements of the final coalgebra are non-wellfounded trees with finite unordered branching,
  representing the evolution of systems starting from a given initial state.

  This paper is dedicated to the construction of the final coalgebra of the finite bag functor in homotopy type theory (HoTT).
  We first compare various equivalent definitions of finite bags employing higher inductive types, both as sets and as groupoids (in the sense of HoTT).
  We then analyze a few well-known, classical set-theoretic constructions of final coalgebras in our constructive setting.
  We show that, in the case of set-based definitions of finite bags,
  some constructions are intrinsically classical, in the sense that they are equivalent to some weak form of excluded middle.
  Nevertheless, the final coalgebra can be safely constructed in HoTT employing the groupoid-based definition of finite bags.
  We conclude by discussing generalizations of our constructions to the wider class of analytic functors.

  \keywords{finite bags, final coalgebra, homotopy type theory, Cubical Agda}
\end{abstract}

\setcounter{tocdepth}{1}
% \tableofcontents

\subsection{TODO}

\begin{itemize}
%  \item
%    Change the focus of the paper:
%    stress preservation-properties (as needed by Adamek's construction).
%    Move story of finality to a separate section.
  \item
    Say that only core claims are formalized
%  \item
%    Idea: hyperlink the formalized theorems from the paper.
  \item
    Be precise about which presentations of types are used.
  \item
    Tone down our claims about \enquote{necessity}, c.f.\@ response
%  \item
%    Give example of transition systems etc.
  \item
    Talk about differences of intrinsically vs.\@ extrinsically quotiented trees.
\end{itemize}

\listoftodos

\section{Introduction}

\emph{Coalgebras} are functions of the form $c : S \to F S$, where $S$ is a set of states and $F$ is a functor specifying a certain class of collections of states \cite{Rutten2000,Jacobs2016}. For example, $F S$ could be lists over $S$, bags (a.k.a. multisubsets) or subsets of $S$ (possibly with some cardinality restrictions), wellfounded trees with leaves or nodes in $S$, or probability distributions over $S$. The coalgebra $c$ describes the dynamics of a transition system or an automaton: to each state $s : S$, the function $c$ associates the collection of states $c \,s : F S$ that are reachable from $s$ in one step. The choice of collection functor $F$ is dictated by the specific flavor of non-determinism that is specified by the transition relation. Does the order or multiplicity of reachable states matter? Is the choice of a new state probabilistic? Does the transition relation additionally depend on a set of labels, weights or actions?

The denotational semantics of a transition system $c : S \to F S$ is typically given in terms of the \emph{final coalgebra} $\Lim{F}$ of the functor $F$, which  consists of non-wellfounded trees with branching specified by $F$. When $F$ is the list functor, each tree has a finite and ordered collection of subtrees. If $F$ is the finite bag functor, the order of subtrees does not matter, and if $F$ is the finite powerset functor, multiplicity of subtrees does not matter either. %Picking $F$ as the finite probability distribution functor, the trees correspond to
The interpretation of a state $s : S$ in $\Lim{F}$ is the possibly-infinite tree obtained by ``running'' the coalgebra $c$ with $s$ as initial state. As such, it gives a complete description of the evolution of the system $c$ starting from state $s$.

The theory of dynamical systems as coalgebras \cite{Rutten2000,Jacobs2016}, and in particular the formal description of final coalgebras \cite{Barr1993,Adamek1995,Worrell2005}, with the associated notion of bisimilarity and behavioural equivalence of states, is traditionally developed in a set-theoretic framework with reasoning based on classical logic. In this work, we propose to study the theory of coalgebras in a framework based on constructive logic, more specifically in homotopy type theory (HoTT) \cite{HoTTBook}. The use of a constructive metatheory is beneficial for the development of \emph{formal denotational semantics} of dynamical systems and programming languages, often centered on the notions of final coalgebra and bisimilarity \cite{Turi1997}, in proof assistants based on variants of Martin-L{\"o}f type theory, such as Agda, Coq, Idris and Lean. The specific choice of HoTT is motivated by its expressiveness and innovative features, higher inductive types (HITs) and the univalence principle, which are crucial ingredients for faithfully representing a variety of collection functors $F$ and reasoning up to equivalent presentations of $F$. 

Specific constructions of final coalgebras for a selection of functors, performed \emph{internally} in HoTT, already exist in the literature. Ahrens el al.~\cite{Ahrens2015} presented a construction of \emph{M-types}, i.e. final coalgebras of polynomial functors. They show that, for a polynomial functor $F$, the traditional set-theoretic construction of its M-type as the $\omega$-limit of the chain
\begin{equation}\label{eq:chain}
    1 \xleftarrow{!} {F 1}
      \xleftarrow{\Map{F} !} {F^2 1}
      \xleftarrow{\Map{F}^2 !} {F^3 1}
      \xleftarrow{\Map{F}^3 !}
      \cdots
\end{equation}
(with $1$ being the unit type and $!$ the unique map into $1$) can be ported without major complications to the setting of HoTT. Veltri \cite{Veltri2021} examined various constructions of the final coalgebra of the finite powerset functor, which is known to not be definable as an $\omega$-limit \cite{Adamek1995}. Worrell proposed a set-theoretic construction as a $(\omega+\omega)$-limit \cite{Worrell2005}, but Veltri showed that this cannot be ported to the constructive setting of HoTT: Worrell's $(\omega+\omega)$-limit is the final coalgebra of the finite powerset functor if and only if the \emph{lesser limited principle of omniscience} (\LLPO{}) holds, which is a constructive taboo \cite{Bridges1987}.


We extend this line of work by studying the final coalgebra of the \emph{finite bag functor}. This is an intermediate situation between finitary polynomial functors, such as the one delivering lists, and general finitary functors, such as the one delivering finite subsets. It also serves as the starting point for a constructive analysis of (final) coalgebras of the \emph{analytic functors} of Joyal \cite{Joyal1986}, arising in type theory from \emph{quotient containers} \cite{Abbott2004} and encompassing many datatypes with symmetries such as finite bags, unordered pairs and cyclic lists \cite{Yorgey2010,Yorgey2014}.

Following the recent work of Choudhury and Fiore \cite{Choudhury2021}, we define and compare various implementations of the type of finite bags in HoTT. Choudhury and Fiore give two equivalent presentations of finite bags as HITs: as free commutative monoids and as lists modulo swapping of adjacent entries. We add an equivalent presentation of finite bags as an analytic functor $\FMSet$: an element of $\FMSet X$ is a pair of a natural number $n$ (its size) and an equivalence class of functions typed $\Fin n \to X$ picking an element of $X$ for each $k < n$. Two functions $v ,w :\Fin n \to X$ belong to the same equivalence class if there merely exists an equivalence $\sigma : \Fin n \to \Fin n$ such that $v = w \circ \sigma$. The type $\FMSet X$ is always a set (in the sense of HoTT, i.e. a type with at most one identification between any two terms), since it employs set-quotienting. Similarly, the HITs of Choudhury and Fiore are sets. Following \cite{Kock2012}, finite bags can alternatively be defined as a polynomial functor $\Bag$ returning a groupoid (in the sense of HoTT, i.e. a type whose equality types are sets) instead of a set. In this case, an element of $\Bag X$ is a pair consisting of a finite type $Y$ and a function from $Y$ to $X$. The set-based and the groupoid-based definitions of bags are appropriately related by the set-truncation construction: $\SetTrunc{\Bag X} \simeq \FMSet X$.

We investigate 3 constructions of the final coalgebra of the finite bag functor:
\begin{enumerate}
\item Working with the set-based functor $\FMSet$, we try to replicate the classical set-theoretic construction as an $\omega$-limit of (\ref{eq:chain}) in our constructive setting. We show that this cannot be directly performed in HoTT without introducing some form of classical logic, an issue already spotted in the case of the finite powerset functor \cite{Veltri2021}. Formally, we show that $\FMSet$ weakly preserves the $\omega$-limit of (\ref{eq:chain}),
  %(actually all $\omega$-limits if one assumes the axiom of countable choice)
but strong preservation of this limit implies \LLPO{}.
\item The list functor admits a final coalgebra $\Lim{\List}$ in HoTT \cite{Ahrens2015} and classically an appropriate quotient of the latter, by a relation $\Bisim$ identifying non-wellfounded trees which differ in the order of their subtrees, delivers the final coalgebra of the finite bag functor.
  This construction is also inherently classical: attempting to define a $\FMSet$-coalgebra structure on $\Lim{\List} \mathbin{/_{\!2}} \Bisim$, i.e. a function of type $\Lim{\List} \mathbin{/_{\!2}} \Bisim \to \FMSet (\Lim{\List} \mathbin{/_{\!2}} \Bisim)$, by directly lifting the $\List$-coalgebra structure of $\Lim{\List}$, implies \LLPO{}. We point out that this issue already appears in the category of \emph{setoids} \cite{Barthe2003}, before effectively forming the set-quotient $\Lim{\List} \mathbin{/_{\!2}} \Bisim$.
  We were able to prove that $\Lim{\List} \mathbin{/_{\!2}} \Bisim$ is the final $\FMSet$-coalgebra only under the assumption of the axiom of choice. 
%We proved that the latter quotient is the final $\FMASet$-coalgebra under the assumption of the axiom of choice. 
%  This construction can be smoothly replicated as a \emph{strict} $\omega$-limit in the category of \emph{setoids} \cite{Barthe2003}. Problems arise when trying to port the latter from setoids to sets, effectively forming the set-quotient $\Lim{\List} \mathbin{/_{\!2}} R$: we prove that the resulting type is a fixpoint for $\FMSet$, in the sense that $\FMSet (\Lim{\List} \mathbin{/_{\!2}} R) \simeq \Lim{\List} \mathbin{/_{\!2}} R$, but showing that this is the final coalgebra requires the assumption of the full axiom of choice. 
\item The groupoid-based polynomial functor $\Bag$ admits a final coalgebra $\Lim{\Bag}$ as the $\omega$-limit of (\ref{eq:chain}), a result arising directly from the work of Ahrens et al.~\cite{Ahrens2015}. $\Lim{\Bag}$ is a groupoid, not a set. One might wonder if the set-truncation $\SetTrunc{\Lim{\Bag}}$ is a good candidate for the final $\FMSet$-coalgebra. We show that it is a fixpoint of $\FMSet$, but we were able to prove that it is the final coalgebra only under the assumption of two variants of the axiom of choice. 
\end{enumerate}
We do not yet know whether the uses of choice in the last two constructions are also necessary. Nevertheless, the set-truncation $\SetTrunc{\Lim{\Bag}}$ can be practically employed as denotational domain for transition systems with a \emph{finite} set of states: given a coalgebra $c : S \to \FMSet S$ where $S$ is (Bishop) finite~\cite{Frumin2018}, there exists a unique coalgebra morphism from $S$ to $\SetTrunc{\Lim{\Bag}}$, and no additional choice principle needs to be assumed in this case. 

We conclude by discussing generalizations of our constructions to other analytic functors.
%and looking at an alternative construction of the final $\FMSet$-coalgebra using Cubical Agda's primitive coinductive types \cite{Vezzosi2019}.
%In Cubical Agda, HITs such as $\FMSet X$ can appear in the codomain of coinductive type destructors, which is intuitively justified by the treatment of HITs in Cubical Agda as inductive types with constructors possibly depending on interval variables \cite{Coquand2018,Cavallo2019}.

The material presented in the paper (apart from Section~\ref{sec:analytic}) has been formalized in the Cubical Agda proof
assistant. The code is freely available at \url{https://github.com/phijor/agda-cubical-multiset}.

\section{Type Theory and Cubical Agda}

We work in homotopy type theory \cite{HoTTBook} and practically our formalization takes place in Cubical Agda \cite{Vezzosi2019}. We recall some basic notions that are employed in our development.

Given a type $A$ and a type family $B$ on $A$, the associated dependent function type is $(x : A) \to B \, x$, written also $\forall x \Where B\,x$ when the type $A$ is clear from context. Implicit arguments of dependent functions are enclosed in curly brackets. Basic inductive types include: unit $1$, empty $\bot$, naturals $ℕ$, finite prefixes of naturals $\Fin n$, lists $\List A$, dependent pair $\sum (x : A) \Where B \, x$, binary sum $A + B$. We use standard names for their constructors. The unique function from a type $A$ into the unit type is $! : A \to 1$. Membership in a list is $x \in xs$ and removal of an occurrence $m : x \in xs$ is $xs \setminus m$. Given an inductive type $T$, we write $\Elim{T}$ and $\Rec{T}$ for its dependent and non-dependent elimination  principles, respectively (we employ the same notation also for higher inductive types). The action on maps of a functor $F : \Type \to \Type$ is $\Map{F}$. Most of our constructions are universe-polymorphic, but for the sake of readability in the paper we use only the two lowest universe of types, $\Type$ and $\Type_1$.

Given $x, y : A$, their definitional equality is denoted $x \DefEq y$ while propositional equality is $x = y$.
Following ``cubical terminology'', the latter is called the \emph{path type} between $x$ and $y$.
In Cubical Agda, the path type $x = y$ behaves similarly to a function type $\Interval \to A$, where $\Interval$ is a primitive interval type with endpoints $i_0$ and $i_1$.
An element $p : x = y$ is eliminated by application to an interval name $r : \Interval$, returning $p \, r : A$.
But unlike function types, this application can compute even when $p$ is unknown by using the endpoints $x$ and $y$: $p \,i_0$ reduces to $x$ and $p \,i_1$ reduces to $y$.
Path introduction is lambda abstraction $(\lambda i : \Interval.\,t) : x = y$, but it causes the extra requirement to match the endpoints: $t[i_0 / i]$ is judgementally equal to $x$ and $t[i_1 / i]$ is judgementally equal to  $y$. We write $\Refl\,x$ for the constant path (i.e. proof of reflexivity) in $x = x$ and $(\bullet)$ for sequential composition of paths.

A function $f : A \to B$ is an \emph{equivalence} if it has contractible fibers, i.e. if the preimage of any element in $B$ under $f$ is a singleton type. Any function underlying a type isomorphism defines an equivalence. Writing $A \simeq B$ for the type of equivalences between $A$ and $B$, Voevodsky's \emph{univalence principle} states that the canonical function of type $A = B \to A \simeq B$ is an equivalence. This is a theorem in Cubical Agda. In particular, there is a function $\Op{ua} : A \simeq B \to A = B$ turning equivalences into path equalities. Univalence implies \emph{function extensionality}: pointwise equal functions are equal.

We recall the first instances of the hierarchy of \emph{homotopy levels}, and say that a type $A$ is:
\begin{itemize}
  \item[] ($n = 1$) a \emph{proposition}, if
    $\IsProp A \DefEq (a , b : A)\Where a = b$ is inhabited,
  \item[] ($n = 2$) a \emph{set}, if
    $\IsSet A \DefEq (a, b : A)\Where \IsProp \ (a = b)$ is inhabited,
  \item[] ($n = 3$) a \emph{groupoid}, if
    $\IsGpd A \DefEq (a, b : A)\Where \IsSet \ (a = b)$ is inhabited.
\end{itemize}
When mentioning \enquote{sets} or \enquote{groupoids}, we always refer to the definition above.

A \emph{higher inductive type} (HIT) is like an inductive type, but its constructors can build both its elements and its (higher) paths. HITs are primitively supported in Cubical Agda. We recall the definition of three basic HITs: propositional truncation, set-truncation and set-quotient. 

The \emph{propositional truncation} $\PropTrunc{A}$ is the proposition associated to the type $A$, i.e. it identifies all the elements and (higher) paths of $A$. It is the HIT with constructors
\begin{center}
  \hspace*{\fill}
    \AxiomC{$a : A$}
    \UnaryInfC{
      $\PropTruncCon[a] : \PropTrunc{A}$
    }
    \DisplayProof
  \hfill
    \AxiomC{$x, y : \PropTrunc{A}$}
    \UnaryInfC{$\PropTruncSquash\,x\;y : x = y$}
    \DisplayProof
  \hspace*{\fill}
\end{center}
We define the \emph{existential quantifier} $\exists (x : A) \Where B\, x \DefEq \PropTrunc{\sum (x : A) \Where B\,x}$, which records the mere existence of an element $x$ satisfying $B$.    

The \emph{set-truncation} $\SetTrunc{A}$ is the set associated to the type $A$, i.e. it identifies all (higher) paths of $A$. It is the HIT with constructors
\begin{center}
  \hspace*{\fill}
    \AxiomC{$a : A$}
    \UnaryInfC{
      $\SetTruncCon[a] : \SetTrunc{A}$
    }
    \DisplayProof
  \hfill
    \AxiomC{$x, y : \SetTrunc{A}$}
    \AxiomC{$p, q : x = y$}
    \BinaryInfC{$\SetTruncSquash\,p\;q : p = q$}
    \DisplayProof
  \hspace*{\fill}
\end{center}

The \emph{set-quotient} $\SetQuot[A][R]$ of a type $A$ by a (possibly proof-relevant) relation
$R : A \to A \to \Type$ is the HIT with constructors
\begin{center}
  \hspace*{\fill}
    \AxiomC{$a : A$}
    \UnaryInfC{
      $\SetQuotCon[a] : \SetQuot[A][R]$
    }
    \DisplayProof
  \hfill
    \AxiomC{$a, b : A$}
    \AxiomC{$r : R \;a\; b$}
    \BinaryInfC{$\operatorname{\mathsf{eq/}}_{\!\mathsf{2}}\,r : \SetQuotCon[a] = \SetQuotCon[b]$}
    \DisplayProof
  \hfill
    \AxiomC{$x, y : \SetQuot[A][R]$}
    \AxiomC{$p, q : x = y$}
    \BinaryInfC{$\SetQuotSquash\,p\;q : p = q$}
    \DisplayProof
  \hspace*{\fill}
\end{center}
The term $\SetQuotCon[a]$ is the $R$-equivalence class of $a$, while the path constructor $\operatorname{\mathsf{eq/}}_{\!\mathsf{2}}$ states that $R$-related elements have path equal equivalence classes. The higher path constructor $\SetQuotSquash$ forces $\SetQuot[A][R]$ to be a set. A set-quotient $\SetQuot[A][R]$ is called \emph{definable} if the equivalence class constructor has a section~\cite{Li2015}, i.e. there is a representative-picking function $\rep: \SetQuot[A][R] \, \to A$ such that $\SetQuotCon[\rep\,x] = x$ for all $x : \SetQuot[A][R]$.

Other HITs are presented in the next section, where we also take a closer look at their elimination principles.



\section{The Finite Bag Functor in Sets}\label{sec:finite-bags-sets}

The action of the finite bag functor on a type $X$ can be encoded as a higher inductive
type in various ways, three of which are presented here.
The first is as the free commutative monoid, the second as lists modulo permutations, the third as an analytic functor.
These are all set-based definitions, in the sense that the type of finite bags is a set.
In \cref{sec:fmset-presentation-equivs}, we prove these are equivalent as types and have the same action on maps,
therefore being equivalent as functors.
Groupoid-based definitions are discussed in Section~\ref{sec:finite-bags-groupoids}.

\subsection{As the Free Commutative Monoid}

Given a type $X$, the \emph{free commutative monoid} on $X$
\cite{Choudhury2021} is the HIT induced by the following rules:
%\begin{itemize}
%  \item Point constructors:
    \begin{center}
      \hspace*{\fill}
        \AxiomC{$\vphantom{X}$}
        \UnaryInfC{$\Empty : \FCM{X}$}
        \DisplayProof
      \hfill
        \AxiomC{$x : X$}
        \UnaryInfC{$\Singl x : \FCM X$}
        \DisplayProof
      \hfill
        \hspace{10pt}
        \AxiomC{$xs, ys : \FCM X$}
        \UnaryInfC{$\Var{xs} \Union \Var{ys} : \FCM X$}
        \DisplayProof
      \hspace*{\fill}
%    \end{center}
 % \item Monoid axioms and commutativity:
      \\[6pt]
%    \begin{center}
      \hspace*{\fill}
        \AxiomC{$\Var{xs} : \FCM X$}
        \UnaryInfC{$\mathsf{unit} : \Empty \Union \Var{xs} = \Var{xs}$}
        \DisplayProof
      \hfill
        \AxiomC{$\Var{xs}, \Var{ys}, \Var{xs} : \FCM X$}
        \UnaryInfC{
          $\mathsf{assoc} : \Var{xs}\Union(\Var{ys}\Union\Var{zs}) = (\Var{xs}\Union\Var{ys})\Union\Var{zs}$
        }
        \DisplayProof
      \hspace*{\fill}
      \\[6pt]
      \hspace*{\fill}
        \AxiomC{$\Var{xs}, \Var{ys} : \FCM X$}
        \UnaryInfC{
          $\mathsf{comm} : \Var{xs}\Union\Var{ys} = \Var{ys}\Union\Var{xs}$
        }
        \DisplayProof
      \hspace*{\fill}
%    \end{center}
%  \item set-truncation:
%    \begin{center}
%      \hspace*{\fill}
        \AxiomC{$\Var{xs}, \Var{ys} : \FCM X$}
        \AxiomC{$p, q : \Var{xs} = \Var{ys}$}
        \BinaryInfC{
          $\mathsf{squash}_{\FCM} \,p\;q : p = q$
        }
        \DisplayProof
      \hspace*{\fill}
    \end{center}
%\end{itemize}

The constructor $\Singl$ embeds $X$ into $\FCM X$, while $\Empty$ and $\Union$ are the unit and multiplication of the monoid. The path constructors express unitality of $\Empty$ wrt. $\Union$, associativity and commutativity of $\Union$, and the final higher path constructor forces $\FCM X$ to be a set.

In Cubical Agda, functions out of HITs like $\FCM X$ can be defined directly by pattern matching. But it is often useful to have elimination principles at hand that give more control on the shape of the proof obligations. For example, the non-dependent elimination principle of $\FCM X$ states that a function of type $\FCM X \to A$ is definable, provided that $A$ is a commutative monoid and there exists a function $\eta^* : X \to A$.
\begin{align*}
  \Rec{\FCM X} &: \{A : \Type\} → \IsSet A \\
    &→ (\varepsilon^* : A) \,(\eta^* : X → A) \, (({+}) : A → A → A) \\
    &→ (∀ a\Where \varepsilon^* + a = a) \\
    &→ (∀ a\, b\, c\Where a + (b + c) = (a + b) + c) \\
    &→ (∀ a\, b\Where a + b = b + a) \\
    &→ \FCM X → A
\end{align*}
$\FCM$ is a functor, with action on maps given by
\begin{align*}
  &\Map{\FCM} : (f : X \to Y) \to \FCM X \to \FCM Y \\
  &\Map{\FCM}\,f \DefEq \Rec{\FCM X}\;\mathsf{squash}_{\FCM}\;\Empty\;(\eta \circ f)\;(\Union)\;\mathsf{unit}\;\mathsf{assoc}\;\mathsf{comm}
\end{align*}

\subsection{As a Quotient of Lists}\label{sec:fmset-list-quot}

Another standard definition of the type of finite bags is as lists modulo permutations. The relation specifying the existence of a permutation between two lists can be given in multiple ways, here we mention two possibilities.

Given $xs, ys : \List X$, the relation $\Perm \,xs \,ys$ is generated by the rules:
\begin{center}
  \hspace*{\fill}
    \AxiomC{$\vphantom{X}$}
    \UnaryInfC{$\Perm \, xs\, xs$}
    \DisplayProof
  \hfill
    \AxiomC{$\Perm\, (xs \Append x \Cons y \Cons ys)\,zs$}
    \UnaryInfC{$\Perm\, (xs \Append y \Cons x \Cons ys)\,zs$}
    \DisplayProof
  \hspace*{\fill}
\end{center}
In other words, $\Perm$ is the reflexive-transitive closure of the relation generated by pairs of lists of the form $xs \Append x \Cons y \Cons ys$ and $xs \Append x \Cons y \Cons ys$. This is a very \enquote{intensional} way of representing permutations of lists: a proof of $\Perm\; xs\; ys$ not only records where each entry in $xs$ is moved to in $ys$, but also how it is moved there. As such, $\Perm \; xs\;ys$ is generally not a proposition. 

Another way of specifying permutations is via a \emph{relation lifting}, often called a \emph{relator} \cite{Levy2011}. Given a relation $R$ on a type $X$, we inductively define a relation $\DRelator R$ on $\List X$, which intuitively states that each occurrence of an element $x$ in the first list is $R$-related to the occurrence of an element $y$ in the second list.
\begin{center}
  \hspace*{\fill}
    \AxiomC{$\vphantom{X}$}
    \UnaryInfC{$\DRelator R\; [\ ]\; ys$}
    \DisplayProof
  \hfill
    \AxiomC{$\exists (y : Y) \Where \sum (m : y \in ys) \Where R\;x\;y \times \DRelator\,R\;xs\;(ys \setminus m)$}
    \UnaryInfC{$\DRelator R\; (x \Cons xs)\;ys$}
    \DisplayProof
  \hspace*{\fill}
\end{center}
We then take the relation lifting of $R$ to be the symmetric closure of the relation $\DRelator R$, i.e. $\Relator R\;xs\;ys \DefEq \DRelator R\;xs\;ys \times \DRelator R\;ys\;xs$.
Because of the presence of a propositional truncation in the premise of the 2nd rule, both $\DRelator R$ and $\Relator R$ are propositionally-valued. If $R$ is reflexive and transitive, than $\Relator R$ is an equivalence relation.

When $R$ is path equality on $X$, the type $\Relator \,(=)\;xs\;ys$ expresses the existence of a permutation connecting $xs$ and $ys$.
In fact, there is a $\PropTrunc{\Perm\;xs\;ys}$ and $\Relator \,(=)\;xs\;ys$ are equivalent types.

\subsection{As an Analytic Functor}

Finally, we introduce the type of finite bags over $X$ as an \emph{analytic functor} (in the formulation of Hasegawa~\cite{Hasegawa2002}):
For any type $X$, define
\begin{align*}
  \FMSet X
    \DefEq
    \sum (\Var{n} : ℕ) \Where
      \SetQuot[(\Fin \Var{n} \to X)][\SymAct \Var{n}]
\end{align*}
where $\SymAct \Var{n}$ is the propositionally-valued relation 
\begin{align*}
  \SymAct n \;v \;w &\mathrel{=_{\mathsf{df}}}
    ∃ (\sigma : \Fin n ≃ \Fin n) \Where
      v = w \circ \sigma
\end{align*}
In other words, an element of $\FMSet X$ is a pair of a natural numbers $n$ (the size of the bag) and an equivalence class of functions $v : \Fin n \to X$ picking an element in $X$ for each index $k < n$. The relation $\SymAct n$ is the action of the symmetric group $\Fin n \simeq \Fin n$ on $n$-tuples of elements of $X$.
We write $\SymActSigma n$ for the non-propositionally-truncated variant of $\SymAct n$. We write $v \sim w$ instead of $\SymAct n \;v \;w$ when $n$ is clear from context, and analogously $\SetQuot[(\Fin n \to X)][\sim]$ in place of $\SetQuot[(\Fin \Var{n} \to X)][\SymAct \Var{n}]$.





%% \begin{definition}
%%   The recursion principle for $\FMSet X$ is the function
%%   \begin{align*}
%%     \Rec{\FMSet}
%%       &: \{A : \Type\} → \IsSet{A} \\
%%       &→ (\Op{as} : \{n : ℕ\} → (v : \Fin n → X) → A) \\
%%       &→ (∀ n\Where (v, w : \Fin n → X) → v \sim_n w → \Op{as} v = \Op{as} w) \\
%%       &→ \FMSet X → A
%%   \end{align*}
%%   defined from the recursion principle of set-quotients.
%%   Similarly, we define the induction principle $\Op{elim}_{\FMSet}$ for
%%   a dependent type family $B : \FMSet X → \Type$ of sets.
%% \end{definition}

%\subsubsection{Finite Choice for Sets}

The proof of Theorem~\ref{thm:FMSetFixpointOfTrunc} employs the fact that $\FMSet$ is closed under set-truncation.  The latter fact factors through the following lemma, stating that set-truncation distributes over finite families of types.
\begin{lemma}[{\CodeRef{Multiset.FiniteChoice}{setFinChoice{$≃$}}}]\label{lem:FiniteChoice}
  For any $n : ℕ$ and type family $Y : \Fin n \to \Type$,
  there is an equivalence
  $
    \Op{box} :
    ((k : \Fin n) → \SetTrunc{\mathop{Y\/} k})
    ≃
    {\SetTrunc{(k : \Fin n) → \mathop{Y\/} k}}.
  $
\end{lemma}
\begin{proof}
  We sketch a proof for a constant type family $Y = (\lambda \Blank \Where X)$.
  The dependent case is analogous.
  The function underlying the equivalence is defined by induction on $n$.
  For $n = 0$ we have $\Fin 0 ≃ \bot$,
  so $\Op{box} \DefEq (\lambda \Blank\Where \SetTruncCon[\Elim{\bot}])$.
  In the inductive step, we lift the derivable \enquote{cons} operation
  $
    (\Cons) : X → (\Fin n → X) → (\Fin{} (1 + n) → X)
  $
  to the set-truncation.
  A two-sided inverse $\Op{unbox} : \SetTrunc{\Fin n → X} → \Fin n → \SetTrunc{X}$ of $\Op{box}$ is given by $\Op{unbox} \bar{v}\, k \DefEq \Map{\SetTrunc{\Blank}} (\lambda v\Where v\, k)\, \bar{v}$.
  %By induction on $n$, we see that
  %\begin{align*}
  %  & \Op{unbox} : \SetTrunc{\Fin n → X} → \Fin n → \SetTrunc{X}\\
  %  &\Op{unbox} \bar{v}\, k \DefEq \Map{\SetTrunc{\Blank}} (\lambda v\Where v\, k)\, \bar{v}
  %\end{align*}
  %The proof uses the fact that $\Map{\SetTrunc{\Blank}}$ is functorial.
\end{proof}
%\begin{definition}
The equivalence of Lemma \ref{lem:FiniteChoice} allows to define a variant of the elimination principle $\Elim{\SetTrunc{X}}$ taking $\Fin n \to \SetTrunc{X}$ as input instead of $\SetTrunc{X}$ (a sort of ``finite choice'' principle for set-truncation):
%taking The principle of finite choice can be defined in terms of $\Op{box}$:
  \begin{equation}\label{eq:finite-choice}
    \def\arraystretch{1.2}
    \begin{array}{l}
    \FinElim : \{n : ℕ\}\, \{B : (\Fin n \to \SetTrunc{X}) \to \Type\} \{s_B : \forall v\Where \IsSet (B\, v)\} \\
      \hspace{1.5cm}\to (c : (w : \Fin n \to X) \to B\, (\SetTruncCon{} \circ w)) \\
      \hspace{1.5cm}\to (v : \Fin n \to \SetTrunc{X}) \to B\, v
    \end{array}
  \end{equation}
 % It is defined by applying $\mathsf{choice}$ to the term obtained from
 % set-truncation elimination on $\operatorname{box} v$.
  This comes with a (propositional) computational rule
  %\begin{align*}
  $\FinElimComp : %(v : \Fin n → X) →
  \FinElim \;c\;(\SetTruncCon{} \circ v) = c\;v$.
  %\end{align*}
%\end{definition}

\begin{theorem}[{\CodeRef{Multiset.FMSet.Properties.STInvariance}{STInvarianceEquiv}}]\label{thm:FMSetSetTruncInvariant}
  $\FMSet$ is invariant under set-truncation: $\FMSet \SetTrunc{X} ≃ \FMSet X$.
\end{theorem}
\begin{proof}
  The equivalence is obtained from an isomorphism.
  The right-to-left map is $\Map{\FMSet}\,\SetTruncCon{}$.
  For the left-to-right map, we use $\FinElim$ to define a function typed
$  %\[
    %\Op{requot} : ∀ \{n\}\Where
    (\Fin n → \SetTrunc{X})
    → \SetQuot[(\Fin n → X)][\sim]
  %\]
  $
  that turns set-truncation into a set-quotient, %and to prove that the latter preserves $(\sim)$.
  %By recursion on $\FMSet \SetTrunc{X}$,
  which is enough to obtain a function typed $\FMSet \SetTrunc{X} → \FMSet X$.
  That these maps are mutual inverses follows from $\FinElimComp$.
\end{proof}

\subsection{Equivalence of Presentations}\label{sec:fmset-presentation-equivs}

All encodings of finite multisets used in the preceding section induce equivalent functors:
\begin{proposition}\label{prop:eqpres}
  For any type $X$, there is a sequence of equivalences
  \[
    \FCM X
      \; \stackrel{\alpha}{≃} \; \SetQuot[\List X][\Perm]
      \; \stackrel{\beta}{≃} \; \SetQuot[\List X][\Relator\;(=)]
      \; \stackrel{\gamma}{≃} \; \FMSet X,
  \]
  which are natural in $X$: for any $f : X → Y$, $\alpha \circ \Map{\FCM} f = \Map{\SetQuot[\List X][\Relator\;(=)]} {} \circ \alpha$, and similarly for $\beta$ and $\gamma$.
\end{proposition}
\begin{proof}
  Equivalence $\alpha$ is obtained by observing that both types form a free commutative monoid on $X$,
  with addition $(\oplus)$ and $(\Append)$ respectively.
  For $\beta$, note that $\Perm$ is a set but $\Relator\;(=)$ is a proposition.
  Yet in general, it is enough to prove there is a bi-implication between the relations to conclude that the set-quotients they define are equivalent,
  as mentioned in \cref{sec:fmset-list-quot}.
  Equivalence $\gamma$ is obtained similarly, this time proving that the encodings of permutations (\enquote{intensionally} via the relator and \enquote{extensional} in terms of equivalence of types) are logically equivalent.
  Naturality is established directly.
\end{proof}
In the formalization, we make use of slight variations of the above types where convenient.
These mostly concern presentation of lists (e.g. bundling lengths via $\List A ≃ \sum_{n : ℕ} \operatorname{Vec} A\; n$),
and are easily seen to be naturally equivalent.


\subsection{Definable Quotients and Sorting}\label{sec:Sorting}

In the proof of Theorem~\ref{thm:PresFMSetSection} we employ the fact that the type of finite bags $\FMSet X$, for some specific choice of $X$, is linearly-ordered and $\SetQuot[(\Fin n \to X)][\sim]$ is a definable set-quotient.
%The proof of Theorem~\ref{thm:PresFMSetSection} relies on the validity of two specific instances of the axiom of countable choice. We show here that these instances hold and therefore Theorem~\ref{thm:PresFMSetSection} is true without the need of postulating countable choice. This is achieved by showing that, whenever a type $X$ is endowed with a linear order $(<)$, then $\SetQuot[\List X][\Perm]$ is a definable set-quotient.
A relation $(<)$ is a \emph{linear order} when it is asymmetric, transitive, propositionally-valued and total, in the sense that the trichotomy $(x < y) + (x = y) + (y < x)$ holds for all $x,y:X$.
If $X$ has a linear order $(<)$, then lists over $X$ can be sorted wrt. $(<)$ via a function $\sort : \List X \to \List X$ essentially implementing the insertion-sort algorithm, so that $\Perm \;xs\;(\sort\,xs)$ holds. Sorting is independent of the positions of each entry in the input list, therefore via $\Rec{\SetQuot[\List X][\Perm]}$ we obtain a function $\sortPerm : \SetQuot[\List X][\Perm] \to \List X$. It is not hard to show that $\sortPerm$ is a section of the equivalence class constructor, so $\SetQuot[\List X][\Perm]$ is a definable quotient.
Since $\SetQuot[\List X][\Perm] \simeq \FMSet X$, we obtain the following result.
\begin{proposition}[{\CodeRef{Multiset.Ordering.FMSetOrder}{SortingFMSet.sortPVect-section}}]\label{prop:ListPermDefQuot}
If $X$ is linearly-ordered, then $\SetQuot[(\Fin n \to X)][\sim]$ is a definable quotient for all $n : ℕ$.
\end{proposition}

Sorting also allows to explicitly find a canonical permutation between any two related lists. Given $p : \Perm \;xs\;ys$, we can find another permutation $\canonicalPerm \;p : \Perm\;xs\;ys$ as follows: there are permutations $\Perm\;xs\;(\sort\,xs)$ and $\Perm\;(\sort\;ys)\;ys$, and moreover the existence of $p$ implies $\sort\,xs = \sort\,ys$. The function $\canonicalPerm$ is constant, since it never inspect the input permutation $p$. 
\begin{proposition}[{\CodeRef{Multiset.Ordering.FMSetOrder}{SortingFMSet.canonicalS}}]\label{prop:ListPermCanonicalPerm}
If $X$ is linearly-ordered, then for all $n : ℕ$ and $v,w : \Fin n \to X$ there exists a function typed $\SymAct n\; v\; w \to \SymActSigma n \;v \; w$ , i.e. the propositional truncation in $\SymAct n\; v\; w$ can be removed.
\end{proposition}

A linear order $(<)$ on $X$ can be extended to a linear order on $\List X$ via the \emph{lexicographic order}:
\begin{center}
  \hspace*{\fill}
    \AxiomC{$\vphantom{X}$}
    \UnaryInfC{$\Lex\, (<)\; [\ ]\; ys$}
    \DisplayProof
  \hfill
    \AxiomC{$x < y$}
    \UnaryInfC{$\Lex\,(<)\;(x \Cons xs) \;(y \Cons ys)$}
    \DisplayProof
  \hfill
    \AxiomC{$x = y$}
    \AxiomC{$\Lex\,(<)\;xs\;ys$}
    \BinaryInfC{$\Lex\,(<)\;(x \Cons xs) \;(y \Cons ys)$}
    \DisplayProof
  \hspace*{\fill}
\end{center}
The lexicographic order can be further extended to a linear order on $\SetQuot[\List X][\Perm]$ by defining $\LexPerm\,(<)\;x\;y \DefEq \Lex\,(<)\;(\sortPerm \,x)\;(\sortPerm \,y)$.
\begin{proposition}[{\CodeRef{Multiset.Ordering.FMSetOrder}{SortingFMSet.linLexFMSet}}]\label{prop:lift-linear-order}
If $X$ is linearly-ordered, then $\SetQuot[(\Fin n \to X)][\sim]$ is linearly-ordered for all $n : ℕ$.  
\end{proposition}


\section{The Final Coalgebra in Sets}\label{sec:final-coalgebra-sets}

We now turn to constructing the final coalgebra of the finite bag functor, given by one of the equivalent definitions in Section~\ref{sec:finite-bags-sets}. %But first, a few basic definitions.

Given an functor $F : \Type \to \Type$, the types of \emph{coalgebras}
and \emph{coalgebra morphisms} between two coalgebras $(A,a)$ and
$(B,b)$ are 
\begin{align*}
  \Coalg\;F &\DefEq \sum (A : \Type) \Where A \to F A \\
  \CoalgMor\,F\,(A,a)\,(B,b) &\DefEq \sum (f : A \to B) \Where \forall x \Where b \,(f\,x) = \Map{F} f \,(a \,x)
\end{align*}
Coalgebras can be used to represent transition systems, e.g.~the coalgebra on the right encodes the small transition system on the left:
\vspace{-.8cm}
\[
\begin{array}{c@{\qquad\qquad\qquad}c}
\xymatrix{
  0 \ar@/^/[rr] \ar@/_/[rr] & & 1 \ar[dl] \ar@(ur,dr) \\
  & 2 &
}
&
\begin{array}{l}
  \\ \\
  c : \Fin 2 \to \FCM (\Fin 2) \\
  c \; 0 \DefEq \Singl 1 \Union \Singl 1 \\
  c \; 1 \DefEq \Singl 1 \Union \Singl 2 \\
  c \; 2 \DefEq \Empty
\end{array}
\end{array}
\]

A coalgebra is \emph{final} if there exists a unique coalgebra morphism to any other coalgebra. This can be formalized by saying that there is a coalgebra $C : \Coalg\;F$ such that the type $\CoalgMor\;F\;C\;D$ is contractible for any other coalgebra $D$. These definitions are the same of Ahrens et al.~\cite{Ahrens2015}, which they only consider in the case of $F$ being a polynomial functor.

We analyze two constructions of the final coalgebra for the finite bag functor: as an $\omega$-limit %(Section~\ref{sec:final-limit-set})
and as a set-quotient of the final coalgebra of the $\List$ functor. %(Section~\ref{sec:final-quotient-set}).
%% Describe limits in general.
%% Maybe compare final coalgebras and corecursive algebras which are fixpoints.
%% \todo[inline]{%
%%   Mention what the type of final coalgebras is.
%%   Use contractibility for UP.
%% }
%% 
%% \subsection{$\omega$-Chains and Limits}
%% 
%% \begin{itemize}
%%   \item definition of chains (in type theory)
%%   \item define type of limits, mention universal property
%%   \item shifted limit
%%   \item mention that $\Op{pres}$ is given by the UP
%% \end{itemize}

\subsection{As an \ensuremath{\omega}-Limit}\label{sec:final-limit-set}

Consider the chain in (\ref{eq:chain}), with $F$ replaced by $\FMSet$. We formally define $\FMSet^n 1$ by recursion on $n$: $\FMSet^0 1 \DefEq 1$ and $\FMSet^{1 + n} 1 \DefEq \FMSet (\FMSet^n 1)$. Similarly we can define the iteration $\Map{\FMSet}^n\,\Bang$, which we denote $\Bang^n_{\FMSet}$.
In HoTT, the \emph{(homotopy) limit} of the chain is definable as
\[
\lim_{n} (\FMSet^n 1) \DefEq \sum (xs : \forall n \Where \FMSet^n 1) \Where \forall n \Where
  \Bang^n_{\FMSet}\,(xs\;(1 + n)) = xs\;n
\]
Write $\Lim{\FMSet} \DefEq \lim_{n} (\FMSet^n 1)$. An element of the limit consists of an element $xs\;n : \FMSet^n 1$, for all $n : ℕ$, and a proof that restricting $xs\;(1 + n)$ to $\FMSet^n 1$ via $\Bang^n_{\FMSet}$ is equal to $xs\;n$. The $n$-th projection from the limit is called $\ell_n : \Lim{\FMSet} → \FMSet^n 1$. The limit is invariant wrt.\@ shifting the chain by one position, i.e. there is an equivalence $\shift : \Lim{\FMSet} \simeq \LimSh{\FMSet}$, where $\LimSh{\FMSet} \DefEq \lim_{n} (\FMSet^{1 + n} 1)$. We use $\ell_n : \LimSh{\FMSet} → \FMSet^{1+n} 1$ also for the $n$-th projection from the shifted limit.
The limit is a set, since all types in its diagram are sets.
Notice that the limit of the chain in (\ref{eq:chain}), with $\FMSet$ replaced by any of its naturally equivalent formulations in Proposition~\ref{prop:eqpres}, is equivalent to $\Lim{\FMSet}$. This implies that, when proving properties of this limit, we can use whichever set-based formulation of finite bags we prefer.

In classical set theory, $\Lim{\FMSet}$ can be proved to be the final coalgebra of $\FMSet$. The proof proceeds by first constructing a function $\pres{\FMSet} : \FMSet \,\Lim{\FMSet} \to \LimSh{\FMSet}$ via the universal property of the limit: take $\ell_n\,(\pres{\FMSet} \,s)$ as $\Map{\FMSet}\,\ell_n \,s$. The function $\pres{\FMSet}$ is then proved to be an equivalence, showing that $\FMSet$ preserves the $\omega$-limit. The composition of $\shift$ with the inverse $\pres{\FMSet}^{-1}$ provides a coalgebra for $\Lim{\FMSet}$. This can be proved to be final, again using the universal property of the limit.

Constructively, there are issues in proving that $\pres{\FMSet}$ is an equivalence. Its injectivity is equivalent to the \emph{lesser limited principle of omniscience} (\LLPO{}) \cite[{Ch.\@ 1}]{Bridges1987}. The latter is a weak version of the law of the excluded middle, and it is not provable from intuitionistic axioms alone.  It states that, given an infinite stream of Boolean
values that yields $\True$ in at most one position, one can decide
whether all even or all odd positions are $\False$.
Both injectivity of $\pres{\FMSet}$ and \LLPO{} are propositions, so it is sufficient to find a bi-implication between them. %But first a useful lemma.

\begin{lemma}[\CodeRef{Multiset.FCM.Limit}{diag-ysᶜ-islim-alternating}]\label{lem:DiagLimCaseAnalysis}
  For $x, y_1, y_2 : \Lim{\FMSet}$, $\Var{ys} : ℕ → \Lim{\FMSet}$
  such that $∀ n\Where \ell_n\,x = \ell_n\,(\Var{ys}\,n)$, and $n : ℕ$, if $\Var{ys}\,n = y_1$ and $\Var{ys}\,(1+n) = y_2$, then $\Bang_{\FMSet}^n(\ell_{1+n}\,y_1) = \ell_n\,y_2$.
\end{lemma}
\begin{proof}
  We have the following sequence of equalities:
  \begin{align*}
    \Bang^n_{\FMSet} (\ell_{1+n}\,y_1)
      &= \ell_n\,y_1 
      = \ell_n\,(\Var{ys}\,n) 
      = \ell_n \,x \\
      &= \Bang^n_{\FMSet}  (\ell_{1+n}\,x) 
      = \Bang^n_{\FMSet} (\ell_{1+n}\,(\Var{ys}\,(1+n))) \\
      &= \Bang^n_{\FMSet} (\ell_{1 + n} \,y_2) 
      = \ell_n \,y_2
  \end{align*}
\end{proof}

\begin{theorem}[\CodeRef{Multiset.FCM.Limit}{pres-inj⇒llpo}]\label{lem:InjPresImpliesComplete}
  If $\pres{\FMSet}$ is injective, then \LLPO{} holds.
\end{theorem}
\begin{proof}
  In this proof we use $\FCM$ instead of $\FMSet$. The statement of the theorem holds since $\FCM X$ is naturally equivalent to $\FMSet X$.
  It is sufficient to show that the injectivity of $\pres{\FCM}$ implies that the following type is inhabited:
  \begin{equation}\label{eq:compl}
    \def\arraystretch{1.2}
    \begin{array}{l}
   \{x, y_1, y_2 : \Lim{\FCM}\} \;(ys : ℕ \to \Lim{\FCM}) \\
  \hspace{.5cm} \to (\Op{split} : \forall n \Where ys\;n = y_1 +  ys\;n = y_2) \;(\Op{diag} : \forall n \Where \ell_n \;x = \ell_n \;(ys\;n)) \\
  \hspace{.5cm} \to \PropTrunc{x = y_1 + x = y_2}
    \end{array}
  \end{equation}
  This is a form of \emph{completeness} of two-element subsets of the $\omega$-limit.
  Mandelkern \cite{Mandelkern1988} has proved the equivalence of \LLPO{} with completeness of two-element subsets of real numbers.
  We adapt their proof, for details refer to either~\cite[{Theorem~7}]{Veltri2021} or the formalization~(\CodeRef{Multiset.ListQuotient.Finality}{complete→llpo}).
  
  To prove completeness, assume $x, y_1, y_2, ys, \Op{split}$ and $\Op{diag}$ as in (\ref{eq:compl}).
  Using $\Op{split}$, define the complement of $\Var{ys}$ as $\overline{\Var{ys}}\;n\DefEq y_2$ if $\Var{ys}\; n = y_1$ and $\overline{\Var{ys}}\;n\DefEq y_1$ if $\Var{ys}\;n = y_2$.
  The diagonal of $\overline{\Var{ys}}$ also has the limit-property,
  i.e.
  \begin{equation}\label{step:IsLimYsComplement}
    ∀ n\Where
    \Bang^n_{\FCM} (\ell_{1 + n} \,(\overline{\Var{ys}}\, (1+n))) = \ell_n \,(\overline{\Var{ys}}\;n)
  \end{equation}
    %  \Step{step:IsLimYsComplement}$$
  For this, fix $n$ and check the four cases generated by inspecting $\Op{split} n$
  and $\Op{split}{} (1+n)$.
  In one case, (\ref{step:IsLimYsComplement}) reduces to the limit-property of $y_1$,
  in another to that of $y_2$ and in the remaining cases to \cref{lem:DiagLimCaseAnalysis}.
  Call  $\overline{x} : \Lim{\FCM}$ the element of the limit such that $\ell_n \,\overline{x} \DefEq \ell_n\,(\overline{ys}\;n)$.

  Write $\{x, y\} \DefEq \eta\, x \oplus \eta\, y$ for the two-element bag comprising of $x$ and $y$. For all $n$, we know that
  %\begin{align}\Step{step:ppc}
    $\{\Var{ys}\;n, \overline{\Var{ys}}\;n\} = \{y_1, y_2\}$
  %\end{align}
  either by $\Op{refl}$ or $\Op{\oplus comm}$, depending on $\Op{split} n$.
  Using the latter equality, the definition of $\pres{\FCM}$ and the assumption $\Op{diag}$, we can form the following sequence of equalities:%\todo{better wording}
  \begin{align*}
    \ell_n\,(\pres{\FCM} \{x, \overline{x}\})
      &= \{\ell_n \,x , \ell_n \,\overline{x}\}
      = \{\ell_n \,(\Var{ys}\;n) , \ell_n\,(\overline{\Var{ys}} \;n)\}\\
      &= \ell_n \, (\pres{\FCM} \{\Var{ys}\;n , \overline{\Var{ys}}\;n\})
      = \ell_n \, (\pres{\FCM} \{y_1 , y_2\})
  \end{align*}
  which implies $\pres{\FCM}\{x, \overline{x}\} = \pres{\FCM}\{y_1, y_2\}$.
  From the injectivity of $\pres{\FCM}$ it follows that $\{x, \overline{x}\} = \{y_1, y_2\}$, which also implies that (merely) $x = y_1$ or $x = y_2$.
\end{proof}

\begin{theorem}[\CodeRef{Multiset.ListQuotient.ToInjectivity}{llpo⇒pres-inj}]\label{lem:LLPOImpliesPresInj}
  \LLPO{} implies the injectivity of $\pres{\FMSet}$.
\end{theorem}
%\begin{proof}
%  \todo[inline]{Prove it.}
%\end{proof}
For the proof of \cref{lem:LLPOImpliesPresInj}, which employs the functor $\SetQuot[\List (-)][\Relator\,(=)]$ instead of $\FMSet$, we refer the reader to our Agda formalization.  The proof is similar to the one of a related result \cite[Theorem 9]{Veltri2021}: the injectivity of $\pres{\Op{Pfin}} : \Op{Pfin} \,\Lim{\Op{Pfin}} \to \LimSh{\Op{Pfin}}$, where $\Op{Pfin}$ is the finite powerset functor, is derivable from \LLPO{} and the axiom of countable choice. It turns out that countable choice is not needed, neither in \cref{lem:LLPOImpliesPresInj} nor in Theorem 9 of \cite{Veltri2021}.

Nevertheless, we are able to salvage in our constructive setting the fact that $\pres{\FMSet}$ has a section/right-inverse. This means that $\FMSet$ weakly preserves the $\omega$-limit $\Lim{\FMSet}$, but strong limit-preservation is equivalent to \LLPO{}.
%irst we show that each set $\FMSet^n 1$ can be endowed with a linear order.
\begin{lemma}[\CodeRef{Multiset.FMSet.Limit}{linLexFMSet\^}]\label{lem:iter-linear}
For all $n$, $\FMSet^n 1$ is linearly-ordered.
\end{lemma}
\begin{proof}
Define $(<^n) : \FMSet^n 1 \to \FMSet^n 1 \to \Type$ by induction on $n$: $(<^0)$ is the empty relation and $x <^{1 + n} y \DefEq \LexPerm\,(<^n)\;x\;y$. Proposition \ref{prop:lift-linear-order} implies that the order $(<^n)$ is linear for all $n$.
\end{proof}

\begin{theorem}[\CodeRef{Multiset.FMSet.Limit}{PresSection.pres-section}]\label{thm:PresFMSetSection}
 The function $\pres{\FMSet}$ has a section.
\end{theorem}
\begin{proof}
  Let $s : \LimSh{\FMSet}$, we build an element $t : \FMSet \,\Lim{\FMSet}$ in the fiber of $\pres{\FMSet}$ over $s$. The size (i.e. the 1st projection) of the bags $\ell_n\,s$ is the same for all $n$, call it $n^*$. We set the size of $t$ to be $n^*$. Given an index $k : \Fin n^*$, we now search for an element $u\,k : \Lim{\FMSet}$ for defining $t \DefEq (n^*,u)$.

  For each $d : ℕ$, we know that $\ell_{d + 1}\,s$ is path equal to a pair of the form $(n^*,v_d)$. In order to construct $u$ we need access to a representative of the equivalence class $v_d : \SetQuot[(\Fin n^* \to \FMSet^d 1)][\sim]$ for each $d$. We know that this can be done using Lemma~\ref{lem:iter-linear} and Proposition~\ref{prop:ListPermDefQuot}. Let $w_d : \Fin n^* \to \FMSet^d 1$ be the canonical representative of $v_d$.
  The limit-property of $s$ can be translated to the mere existence of a permutation $\sigma_d : \Fin n^* \simeq \Fin n^*$
  such that $p : \Bang_{\FMSet}^d(w_{1 + d}\, k) = w_d \,(\sigma_d\,k)$, for all $d: ℕ$ and $k : \Fin n^*$. The construction of $u$ also requires access to each permutation $\sigma_d$, which sits inside a propositional truncation for each $d$. We can access all these permutations by invoking Lemma~\ref{lem:iter-linear} and Proposition~\ref{prop:ListPermCanonicalPerm}.

  We now have all the ingredients for building $u$. Define a permutation $\sigma^*_d : \Fin n^* \simeq \Fin n^*$ by induction on $d$: $\sigma^*_0 \DefEq \Op{id}$, $\sigma^*_{1+d} \DefEq \sigma_d^{-1} \circ \sigma^*_d$. Then take $u$ such that $\ell_d \,(u\,k) \DefEq w_d\,(\sigma^*_d \,k)$. One can show that $u\,k : \Lim{\FMSet}$ for all $k : \Fin n^*$ since
  $\Bang_{\FMSet}^d (w_{d+1}(\sigma^*_{d+1}\, k)) \stackrel{p}{=} w_d (\sigma_d (\sigma^*_{d+1}\, k)) = w_d (\sigma_d (\sigma_d^{-1} (\sigma^*_d\, k))) = w_d (\sigma^*_d\, k)$,
  and that $t$ is indeed in the fiber of $\pres{\FMSet}$ over $s$.
\end{proof}

Assuming \LLPO{} we have $\FMSet \Lim{\FMSet} \simeq \Lim{\FMSet}$, and proving that the coalgebra underlining this equivalence is final is straightforward using the universal property of the limit.

\subsection{As a Quotient of the Final $\List$-Coalgebra}\label{sec:final-quotient-set}

It is known that the limit $\Lim{\List} \DefEq \lim_n (\List^n 1)$ is the final coalgebra of the list functor in HoTT~\cite{Ahrens2015}.
The limit $\Lim{\List}$ is a type of non-wellfounded \emph{ordered} trees,
and we denote by $\coalg{\List}$ its coalgebra structure.
By choosing a suitable relation $R$, one can hope to obtain a type of
\emph{unordered} trees $\SetQuot[\Lim{\List}][R]$ that induces a coalgebra structure on $\FMSet$.
We chose $R$ to be a notion of \emph{bisimilarity} $\Bisim$,
obtained iteratively from the \emph{relation lifting} $\Relator$ applied to finite approximations of trees in $\Lim{\List}$~\cite{Hasuo2013}:
\[
\begin{array}{l}
  \Approx^n : \List^n 1 → \List^n 1 → \Type \\
  \Approx^0 x\;y \DefEq 1 \\
  \Approx^{1+n}\;x\;y \DefEq \Relator \,(\Approx^n)\;x\,y.
\end{array}
\]
From the fact that $(\forall x,y\Where R \,x\,y \to S \,x\,y)$ implies $\forall xs,ys \Where \Relator  R\;xs\;ys \to \Relator S\;xs\;ys$,
we obtain, for $s, t : \Lim{\List}$, a chain of propositions
\begin{equation}\label{eq:chain-rel}
  \Approx^0 (\ell_0\; s)\; (\ell_0\; t)
    \xleftarrow{} {\Approx^1 (\ell_1\; s)\; (\ell_1\; t)}
    \xleftarrow{} {\Approx^2 (\ell_2\; s)\; (\ell_2\; t)}
    \xleftarrow{} %{\Map{F}^3 !}
      \cdots
\end{equation}
The desired relation $\Bisim\,s\,t$ is the limit of the chain in (\ref{eq:chain-rel}).

Before proceeding to investigate $\SetQuot[\Lim{\List}][\Bisim]$,
one might wonder if $\coalg{\List}$ lifts to a coalgebra of setoids $(\Lim{\List}, \Bisim) → (\List \Lim{\List}, \Relator \Bisim)$.
For this, one needs to show that it is a \emph{setoid-morphism},
i.e.\@ for $s, t : \Lim{\List}$, whenever $\Bisim\;s\;t$
then $\Relator \Bisim\; (\coalg{\List} s)\; (\coalg{\List} t)$.
Once again, the same issue we found when trying to prove the injectivity of $\pres{\FMSet}$ in Section~\ref{sec:final-limit-set} arises:

\begin{theorem}[\CodeRef{Multiset.ListQuotient.LLPO}{fix⁻-preserves-≈→LLPO}]
  If $\coalg{\List}$ is a setoid-morphism, then \LLPO{} holds.
\end{theorem}
The proof is similar to that of \cref{lem:InjPresImpliesComplete}.
Similar to \cref{lem:LLPOImpliesPresInj}, the converse is true also.
Nevertheless, the inverse of $\coalg{\List}$ is always a setoid-morphism.
Therefore $\coalg{\List}$ is an equivalence of setoids whenever it is a setoid-morphism,
i.e.\@ \LLPO{} holds.
Under this assumption alone it is the final coalgebra of an endofunctor in the category of setoids:
\todo{Give definition of this category}

\begin{theorem}[\CodeRef{Multiset.ListQuotient.Finality}{finalFMSetoidCoalgebra}]\label{thm:final-setoids}
  Assuming $\coalg{\List}$ is a setoid-morphism,
  the setoid $(\Lim{\List},\Bisim)$ has a coalgebra structure for the functor
  $(X, R) \mapsto (\List X, \Relator R)$
  which is final in the category of setoids.
\end{theorem}

Similarly to the case of the finite powerset, set-quotienting $\Lim{\List}$ by the relation $\Bisim$ does not obviously give the final coalgebra of $\FMSet$.
We can show that the resulting quotient is a fixpoint, and in particular a coalgebra (of sets):
\begin{theorem}[\CodeRef{Multiset.ListQuotient.Fixpoint}{FMSetFixpointTree/Bisim}]\label{thm:fixpoint-quotient}
  If $\coalg{\List}$ is a setoid-morphism,
  it lifts to an equivalence $\coalg{\FMSet} : \SetQuot[\Lim{\List}][\Bisim] \xrightarrow{≃} \FMSet(\SetQuot[\Lim{\List}][\Bisim])$.
\end{theorem}
\begin{proof}
  For the proof, we employ the equivalent functor $\SetQuot[\List (-)][\Relator\,(=)]$ instead of $\FMSet$.
  Let $U \DefEq \SetQuot[\Lim{\List}][\Bisim]$ be the type of unordered trees.
  The assumption implies that $\coalg{\List}$ lifts to a function $U → \FMSet U$,
  definable by recursion on the set-quotient.
  An inverse $\FMSet U → U$ is definable since $\coalg{\List}^{-1}$ is always a setoid-morphism
  and $\SetQuot[\List X][\Relator R]$ is an \emph{effective quotient} for any setoid $(X, R)$.
\end{proof}

However, we were able to prove that this fixpoint is the final coalgebra only under the assumption of the axiom of choice. 
\begin{theorem}[\CodeRef{Multiset.ListQuotient.Fixpoint}{TerminalfixQ⁻}]\label{thm:final-quotient}
  Assuming axiom of choice, the fixpoint of \cref{thm:final-quotient} carries the structure of the final $\FMSet$-coalgebra.
\end{theorem}
\begin{proof}
  We only discuss the particular instance of choice used in the proof, which is analogous to a related one for the finite powerset functor in \cite{Veltri2021}.
  Abbreviate unordered trees again as $U$ and $R \DefEq \Relator\; (=)$, and use the presentation of $\FMSet$ as in \cref{thm:fixpoint-quotient}.
  To build a coalgebra morphism $u_c : C → U$ from a given coalgebra $c : C \to \FMSet C$ to $\coalg{\FMSet} : U → \FMSet U$,
  one can define a function $u' : \SetQuot[(C → \List C)][R^*] → (C → U)$.
  Here, $R^*$ is the pointwise lifting of $R$,
  and $u'$ is obtained by recursion from the unique $\List$-coalgebra morphism $C → \Lim{\List}$.
  The axiom of choice implies that the canonical map $(C → \SetQuot[\List][R]) → \SetQuot[(C → \List C)][R^*]$
  has a section $\theta$ for \emph{arbitrary} $C$.
  This is is sufficient to prove that $u_c \DefEq u'(\theta(c))$ is the unique coalgebra morphism from $(C,c)$ to $(\coalg{\FMSet},\SetQuot[\Lim{\List}][\Bisim])$.
\end{proof}

%While not delivering the final coalgebra of $\FMSet$ without extra classical assumptions, the quotient $\SetQuot[\Lim{\List}][\Bisim]$ can still be used as a denotational domain for transition systems with a finite set of states:
%given a coalgebra $c : S \to \FMSet S$ where $S$ is (Bishop) finite, the existence of the section $\theta$ is implied by a finite-choice argument.

\section{The Finite Bag Functor in Groupoids}\label{sec:finite-bags-groupoids}

The results of Section~\ref{sec:final-coalgebra-sets} are evidence that the set-based definitions of finite bags from Section~\ref{sec:finite-bags-sets} are not fit for a fully constructive construction of the final coalgebra. In this section we study a groupoid-based definition and, following the ideas of Kock~\cite{Kock2012} and Finster et al.~\cite{Finster2021},  argue that the correct perspective on finite bags in HoTT is to define them as groupoids instead of sets, particularly for the goal of final semantics.
The rationale is that identifications of bags are permutations, and these should inherently be treated as \emph{data}.
Instead of viewing bags as quotients of lists, thereby \enquote{forgetting} about the permutations,
we define a type of lists with \enquote{more identifications}.
Since all constructions based on this type have to be homotopy coherent,
they will automatically respect the extra data,
making them invariant under permutation for free.
We define two equivalent type families $\Tote,\Bag : \Type → \Type$ of finite bags valued in groupoids,
and substantiate the previous claims by showing that the set-truncation of the former is equivalent to $\FMSet$ (\cref{thm:FMSetOfFMGpdTrunc}),
and constructing the final coalgebra of the latter in a straightforward way %(\cref{ssec:FMGpdLim},
(\cref{thm:FMGpdLim}).

First, recall one way of defining finite sets in HoTT \cite{Frumin2018}.
%\begin{definition}
  A type $B$ is called \emph{(Bishop-) finite} if
  $
    \Op{isFinSet} B \DefEq
      \sum (n : ℕ)\Where \PropTrunc{B ≃ \Fin n}
  $
  holds,
  and we denote the collection of such types by
  $
    \Op{FinSet} \DefEq
      \sum (B : \Type)\Where \Op{isFinSet} B.
  $
  The underlying type of a $\FinSet$ is accessed via the first projection $\langle - \rangle : \FinSet → \Type$.
%\end{definition}

The type $\Op{isFinSet} B$ is a proposition and any type $B$ satisfying the predicate is a set.
It follows that $\Op{FinSet}$ forms a groupoid.
Note that $\Op{FinSet}$ is a \emph{large} type, i.e. $\Op{FinSet} : \Type_1$.
%it lives in the successor universe of the types that it ranges over.
From this, we can define a \enquote{tote} (in the sense of a \enquote{large bag}) $\Tote : \Type → \Type_1$ as
%, which we think of as a finite collection of elememts in $X$:
%\begin{definition}
%  A large type, $\Tote : \Type_\ell → \Type_{\ell + 1}$:
  \begin{align*}
    \Tote X
      \mathbin{=_{\mathrm{df}}}
      \sum\,(\Var{B} : \Op{FinSet})\Where \langle B \rangle \to X,
  \end{align*}
%\end{definition}
Elements of $\Tote X$ are pairs consisting of a finite set $B$ and a function from (the type underlying) $B$ to $X$ which picks the elements in the tote.  Univalence implies that the path type $(B,v) = (C,w)$ in $\Tote X$ is equivalent to the type of dependent pairs consisting of an equivalence $\sigma : \langle B \rangle \simeq \langle C\rangle$ and a path $v = w \circ \sigma$.
This indicates that $\Tote X$ is not a set, in general it is at least a groupoid.
\begin{proposition}[\CodeRef{Multiset.Tote.Properties}{isGroupoidTote}]
  If $X$ is a groupoid, then $\Tote X$ is a groupoid.
\end{proposition}
\begin{proof}
  Since $X$ is a groupoid, the function type $\langle B \rangle → X$ is a groupoid
  for any $B : \FinSet$.
  $\FinSet$ is also a groupoid, so the entire $\Sigma$-type is a groupoid.
\end{proof}
$\Tote X$ differs from $\FMSet X$ in that path equality in the former records the permutations between the (finite sets representing) sizes of the bags, while the second only cares about the mere existence of a permutation. Nonetheless, the two definitions become equivalent when we set-truncate the type of totes.
\begin{theorem}[\CodeRef{Multiset.Tote.Properties}{FMSet{$≃$}{$\|$}Tote{$\|$}{\textsubscript{2}}}]\label{thm:FMSetOfFMGpdTrunc}
  For any type $X$, $\SetTrunc{\Tote X} ≃ \FMSet X$. The equivalence is natural in $X$.
\end{theorem}
\begin{proof}
  The proof proceeds by constructing an isomorphism $\FMSet X \cong \SetTrunc{\Tote X}$.
  %The forward direction is unproblematic, while the inverse function has to be carefully defined with the homotopy levels of the involved types in mind.

  A function $\ToTote : \FMSet X → \SetTrunc{\Tote X}$ is defined by
  %invoking $\Rec{\FMSet}$, so it is enough to
  giving a function
  $f : \forall \{\Var{n}\}\Where (\Fin \Var{n} → X) → \SetTrunc{\Tote X}$
  and show that it respects $(\sim)$.
  Take $f(v) \DefEq \SetTruncCon[(\Fin \Var{n} , v)]$, since $\Fin \Var{n}$ is a finite set.
  To prove that $v \sim w$ implies $f(v) = f(w)$, note that the conclusion is a proposition,
  thus by invoking the recursion principle of propositional truncation we can assume given a permutation $\sigma$ such that $r : v = w \circ \sigma$.
  By univalence, $\Op{ua} \sigma : \Fin \Var{n} = \Fin \Var{n}$,
  and transporting $r$ along this path yields
  $
    p : (\Fin\Var{n} , v) = (\Fin\Var{n}, w)
  $.
  Then $\Op{cong} \SetTruncCon\, p : f(v) = f(w)$ as desired.

  A function $\ToFMSet : \SetTrunc{\Tote X} → \FMSet X$ is defined
  via $\Rec{\SetTrunc{\Tote X}}$, so it is enough to provide $g : \Tote{X} → \FMSet X$. %which is given as $g\, ((B, \Var{n}, e), v) \DefEq (\Var{n} , g')$.
  Assume given a finite set $B$ of size $\Var{n}$ with $e : \PropTrunc{B ≃ \Fin\Var{n}}$ and $v : B → X$. We would like to return something in $\SetQuot[(\Fin\Var{n} → X)][\mathord{\sim}]$ by recursion on $e$, but this cannot work since the return type is a set.
%  We would like to use a composition $\Fin\Var{n} → Y → X$ to find
%  $g' : \SetQuot[(\Fin\Var{n} → X)][\mathord{\sim}]$,
%  but one cannot do so because $e$ is propositionally truncated.
%  Using induction directly on $e$ cannot work, since $g'$ lives in a set.
  We can however employ a different recursion principle of propositional truncation \cite[{Corollary~2}]{Capriotti2015}, which allows to define a function into a set provided that it is \emph{(weakly) constant} (in the sense of \cite{Kraus2017}). Define  
%  \begin{align*}
    $g' : (B ≃ \Fin\Var{n}) → \SetQuot[(\Fin\Var{n} → X)][\mathord{\sim}]$ as $g'\, \alpha \DefEq \SetQuotCon[v \circ \alpha]$, which can be proved to be constant and therefore well-defined. We can then take $g\, ((B, \Var{n}, e), v) \DefEq (\Var{n} , g'\,e)$.
  %\end{align*}
  Proving $\ToFMSet \circ \ToTote = \Op{id}$ is straightforward.
  Proving $\ToTote \circ \ToFMSet = \Op{id}$ reduces to showing that $v \circ \alpha \sim v$ for any $v : B → X$ and $\alpha : \Fin n ≃ B$, which is also direct.
\end{proof}

$\Tote X$ is a large type, but an equivalent small variant can be defined with the help of HITs.
%it is unsuitable for iteration, as the assignment $(\lambda n\Where \Tote^n \mathsf{1})$
%of $n$-fold applications of the family is not well-typed.
%typeable in a universe of bounded size.
Following \cite{Finster2021}, we first introduce an equivalent but small definition $\Bij$ of the type of finite sets $\Op{FinSet}$. This is the \emph{groupoid-quotient} \cite{Sojakova2016,VeltriW21} of the (categorical) groupoid with objects given by natural numbers and morphisms between $n$ and $m$ given by equivalences in $\Fin m ≃ \Fin n$.
  \begin{center}
%    \small
    \hspace*{\fill}
      \AxiomC{$n : \N$}
      \UnaryInfC{
        $\Obj n : \Bij$
      }
      \DisplayProof
    \hfill
      \AxiomC{$m, n : \N$}
      \AxiomC{$\alpha : \Fin m ≃ \Fin n$}
      \BinaryInfC{$\Hom\,\alpha : \Obj m = \Obj n$}
      \DisplayProof
    \hspace*{\fill}
    \\[1em]
    \hspace*{\fill}
      \AxiomC{$m, n, o : \N$}
      \AxiomC{$\alpha : \Fin m ≃ \Fin n$}
      \AxiomC{$\beta : \Fin n ≃ \Fin o$}
      \TrinaryInfC{$\Hom\,(\beta \circ \alpha) = \Hom\, \alpha \bullet \Hom\, \beta$}
      \DisplayProof
      \hspace*{\fill}
        \AxiomC{$\vphantom{X}$}
        \UnaryInfC{$\IsGpd \;\Bij$}
        \DisplayProof
    \hspace*{\fill}
  \end{center}
  %Here, $\operatorname{id}$ is the identity-equivalence, $(\circ)$ composition of equivalences,
  \begin{proposition}[\CodeRef{Multiset.Bij.Properties}{Bij{$≃$}FinSet}]\label{prop:BijFinSet}
    There is an equivalence $\Bij \simeq \Op{FinSet}$. In particular, one can extract a type $\langle x \rangle : \Type$ from each $x : \Bij$:
  \end{proposition}
  A small type of finite bags %valued in groupoids
  is defined by replacing $\Op{FinSet}$ with $\Bij$.
%\begin{definition}\label{def:Bag}
%  A small type:
  \begin{align*}
    \Bag X
      \DefEq
      \sum (\Var{x} : \Bij) \Where
        \langle x \rangle \to X
  \end{align*}
% We abbreviate $\BagCon{v} \DefEq (x, v) : \Bag X$ if $x : \Bij$ can be inferred from context.
%\end{definition}
%\paragraph{Comparing $\Op{List}$ and $\Bag$}\todo{Fit this comparison in somewhere}
  \begin{proposition}[\CodeRef{Multiset.Bag.Properties}{Bag{$≃$}Tote}]\label{prop:BagTote}
    For any type $X$, the equivalence of Proposition~\ref{prop:BijFinSet} extends to an equivalence $\Bag X \simeq \Tote X$.
  \end{proposition}
 Notice that $\Bag$ is the \emph{polynomial functor} associated to the container with $\Bij$ as shapes and $\langle x \rangle$ as positions at shape $x$. This can be seen as a \enquote{higher, more informative} variant of the list functor, which has $ℕ$ as shapes and $\Fin n$ as positions at shape $n$, a statement substantiated by Theorem \ref{thm:FMSetOfFMGpdTrunc}.

We conjecture that $\Bag X$ can be proved equivalent to the \emph{free symmetric monoidal groupoid} on $X$ defined as a HIT by Piceghello \cite{Piceghello2021}, which would serve as an alternative proof of MacLane's coherence for symmetric monoidal categories.

% , in a way analogous to $\Op{List}$:
%Given a type $A$ and a family $B$ over it, they both match ${\sum (a : A)\Where B(a) → X}$:
%we have $A = ℕ$ and $B = \Fin$ for $\Op{List}$,
%and $A = \Bij$ and $B = \BagCon{\Blank}$ for $\Bag$.
%In particular, $\SetTrunc{\Bij} ≃ ℕ$.

\section{The Final Coalgebra in Groupoids}\label{sec:final-coalgebra-groupoids}


%\subsection{Final Coalgebras as an $\omega$-Limit in Groupoids}\label{ssec:FMGpdLim}

Since $\Bag$ is a polynomial functor, its final coalgebra can be computed as the $\omega$-limit $\Lim{\Bag} \DefEq \lim_n (\Bag^n 1)$ \cite{Ahrens2015}. Ahrens et al. construction does not restrict the homotopy level of the polynomial functors, so it works also for $\Bag$ for which the limit $\Lim{\Bag}$ is a groupoid. Notice that a variant $\Tote' : \Type_1 \to \Type_1$ of $\Tote$, which does not raise the universe level, could in principle be replaced for $\Bag$ in the limit, by first lifting the unit type 1 to the universe $\Type_1$. The resulting limit would be a large groupoid in $\Type_1$.
\begin{theorem}[\CodeRef{Multiset.Bag.Properties}{bagLimitEquiv}]\label{thm:FMGpdLim}
  The map $\pres{\Bag} : \Bag\,\Lim{\Bag} \to \LimSh{\Bag}$ is an equivalence of groupoids.
\end{theorem}

\begin{corollary}[Theorem 7 of \cite{Ahrens2015}]
  $\Lim{\Bag}$ is the final $\Bag$-coalgebra.
\end{corollary}

The combination of \cref{thm:FMSetOfFMGpdTrunc} and
\cref{prop:BagTote}, together with the fact that set-truncation
preserve equivalences, implies that $\SetTrunc{\Bag^n 1}$ is
equivalent to $\FMSet^n 1$ for all $n$. One might wonder whether the
set-truncation of $\Lim{\Bag}$ delivers the final coalgebra of
$\FMSet$. We are able to show that $\SetTrunc{\Lim{\Bag}}$ is a
fixpoint of $\FMSet$. But to prove finality, we
require the additional assumption of the axiom of choice and a
``higher'' version $\mathsf{AC}_{3,2}$ of the axiom of choice \cite[Exercise 7.8]{HoTTBook}, which states that for set $X$ and groupoid-valued type family $Y$ on $X$, the following type is inhabited: $((x : X) \to \SetTrunc{Y\;x}) \to \SetTrunc{(x : X) \to Y \;x}$.
\begin{theorem}[\CodeRef{Multiset.FMSet.Fixpoint}{FMSetFixSetTruncTree}]\label{thm:FMSetFixpointOfTrunc}
  %The set-truncation of $\Lim{\Bag}$ is a fixpoint of $\FMSet$, i.e.\@
  There is an equivalence $\FMSet \SetTrunc{\Lim{\Bag}} ≃ \SetTrunc{\Lim{\Bag}}$.
\end{theorem}
\begin{proof}
  The equivalence is obtained from the composition
  \begin{align}
    \FMSet \SetTrunc{\Lim{\Bag}}
      &≃ \FMSet \Lim{\Bag}          \Step{thm:FMSetFixpointOfTrunc:step1} \\
      &≃ \SetTrunc{\Bag \Lim{\Bag}} \Step{thm:FMSetFixpointOfTrunc:step2} \\
      &≃ \SetTrunc{\Lim{\Bag}}      \Step{thm:FMSetFixpointOfTrunc:step3}
  \end{align}
  where \eqref{thm:FMSetFixpointOfTrunc:step1} is invariance of $\FMSet$ under set-truncation
  (\cref{thm:FMSetSetTruncInvariant}),
  \eqref{thm:FMSetFixpointOfTrunc:step2} follows from Theorems~\ref{thm:FMSetOfFMGpdTrunc} and \ref{prop:BagTote},
  and \eqref{thm:FMSetFixpointOfTrunc:step3} follows from \cref{thm:FMGpdLim}.
  %since $\Lim{\Bag}$ is a limit.
\end{proof}
Let $\coalg{\FMSet}$ be the coalgebra underlying the equivalence of Theorem \ref{thm:FMSetFixpointOfTrunc}.
%We employ an alternative formulation of the axiom of choice, provably equivalent to more standard formulations~\cite{Veltri2021}. Given types $X,Y$ and a relation $R$ on $Y$, define the relation $X \to R$ on $X \to Y$ as the pointwise lifting of $R$ to functions. The axiom of choice states that the function $\theta_R : \SetQuot[(X \to Y)][(X \to R)] \to (X \to \SetQuot[Y][R])$, definable via $\Rec{\SetQuot[X \to Y][X \to R]}$, has a section. From the fact that $e : (\SetQuot[X][{=}]) \simeq \SetTrunc{X}$, the axiom of choice gives in particular a function $\psi : (X \to \SetTrunc{Y}) \to \SetTrunc{X \to Y}$ which is a right-inverse of $\theta_{=}$ (up to equivalence $e$).
\begin{theorem}\label{thm:final-set-truncation}
  Assuming axiom of choice and $\mathsf{AC}_{3,2}$, $\SetTrunc{\Lim{\Bag}}$ is the final coalgebra of $\FMSet$.
\end{theorem}
\begin{proof}
Let $c : X \to \FMSet X$ be a coalgebra, which by \cref{thm:FMSetOfFMGpdTrunc} and \cref{prop:BagTote} is equivalent to having a function $c' : X \to \SetTrunc{\Bag X}$. Applying $\mathsf{AC}_{3,2}$ on $c'$ gives $c'' : \SetTrunc{X \to \Bag X}$. Invoking $\Rec{\SetTrunc{X \to \Bag X}}$ on $c''$, we receive $g : X \to \Bag X$. From the finality of $\Lim{\Bag}$ in \cref{thm:FMGpdLim}, there exists a unique coalgebra morphism $f^* : X \to \Lim{\Bag}$ and we define $f\,x \DefEq \SetTruncCon[f^*\,x]$. The function $f$ is the desired unique coalgebra morphism between $(X,c)$ and $(\SetTrunc{\Lim{\Bag}},\coalg{\FMSet})$. The proof of uniqueness uses an application of the axiom of choice. We refer to the formalization for details.
\end{proof}
%We do not yet know what is the strength of assuming the existence of a section for $\theta_X$ and how it compares to well-known choice principles. It resembles a form of choice: if set-truncation is replaced with propositonal truncation, then it becomes a particular instance of the axiom of choice.
In the absence of the axiom of choice and $\mathsf{AC}_{3,2}$, the type $\SetTrunc{\Lim{\Bag}}$ can still be used to give semantics to transition systems with \emph{finite} set of states.
\begin{proposition}
For all $n : \N$ and coalgebra $c : \Fin n \to \FMSet (\Fin n)$, there exists a unique coalgebra morphism from $(\Fin n,c)$ to $(\SetTrunc{\Lim{\Bag}},\coalg{\FMSet})$.
\end{proposition}
This is true since $\mathsf{AC}_{3,2}$ holds when $X$ is equivalent to $\Fin n$, it follows from the \enquote{finite choice} principle in Lemma \ref{lem:FiniteChoice}. The particular instance of the axiom of choice used in the proof of Theorem \ref{thm:final-set-truncation} also holds when $X ≃ \Fin n$.

%% Note that the above fixpoint is not necessarily the \emph{largest} fixpoint.
%% \todo[inline,caption={Choice for largest fixpoint}]{%
%%   \emph{(Unproven)}
%%   Only assuming the (full) axiom of choice this is the case, i.e.\@ yields a final coalgebra.
%%   }

%\section{Alternatives and Generalizations}

%We now look at an alternative construction of the final coalgebra using coinductive types and a generalization of our constructions to other analytic functors.

\section{Other Analytic Functors}\label{sec:analytic}

The formulation $\FMSet$ of the finite bag functor exposes this as an analytic functor \cite{Joyal1986,Hasegawa2002}, which differs from a polynomial functor in that the tuple of elements $\Fin\,n \to X$ is quotiented by the relation generated by the action of the symmetric group with $n$ elements on $X$. Other analytic functors arise by choosing a different subgroup of the symmetric group. For example, picking the subgroup of cyclic permutations delivers the functor of cyclic lists, while taking the trivial subgroup allows us to recover the list functor. 

More generally, in type theory analytic functors can be seen as instances of the functors associated to the \emph{quotient containers} of Abbott et al.~\cite{Abbott2004}. A quotient container is a triple consisting of a type $A$, a type family $B : A \to \Type$ and a propositionally-valued type family $P : \forall \{a\} \Where B \,a \simeq B \,a \to \Type$ closed under identity, inverses and composition of equivalences. The associated functor is:
\[
\Op{F}_{A,B,P}\,X \DefEq \sum (a : A) \Where \SetQuot[(B\,a \to X)][\Op{Act} \,P\,a]
\]
where the relation $\Op{Act} \,P\,a$ is
\[
\Op{Act} \,P\,a\;v\;w \DefEq 
    ∃ (\sigma : B\,a ≃ B\,a) \Where P\,\sigma \times
      (v = w \circ \sigma)
\]
The type $\Op{F}_{A,B,P}\,X$ is a set whenever the type of shapes $A$ is a set. The functor $\FMSet$ corresponds to the instance where $A \DefEq ℕ$, $B \DefEq \Fin$ and $P\,\sigma \DefEq 1$.

We know that the construction of the final coalgebra as an $\omega$-limit in the category of sets for a general analytic functor $\Op{F}_{A,B,P}$ is constructively problematic, since it is already problematic for $\FMSet$. Nevertheless, one can ask if a result like Theorem~\ref{thm:PresFMSetSection} is valid for any $\Op{F}_{A,B,P}$. We do not know how to generally define a section for the function $\pres{\Op{F}} : \Op{F}_{A,B,P} (\lim_{n} (\Op{F}_{A,B,P}^n 1)) \to \lim_{n} (\Op{F}_{A,B,P}^{1 + n} 1)$. But we know how to prove the surjectivity of $\pres{\Op{F}}$ under the assumption of the axiom of countable choice. The proof of Theorem~\ref{thm:PresFMSetSection} relies on Propositions~\ref{prop:ListPermDefQuot} and \ref{prop:ListPermCanonicalPerm}, which are very specific properties of the finite bag functor.
The employment of these propositions can be seen as the invocation of two specific instances of the axiom of countable choice, which happen to hold in the case of $\FMSet$.

Each quotient container $(A,B,P)$ also specifies a polynomial functor $\Op{G}_{A,B,P}$ valued in groupoids, akin to the functor $\Bag$. First, the small HIT construction of the groupoid of finite types $\Bij$ can be generalized:
  \begin{center}
    \hspace*{\fill}
      \AxiomC{$a : A$}
      \UnaryInfC{
        $\Obj a : \Op{U}_{A,B,P}$
      }
      \DisplayProof
    \hfill
      \AxiomC{$a : A$}
      \AxiomC{\hspace{-.5cm}$\alpha : B a ≃ B a$}
      \AxiomC{\hspace{-.5cm}$p : P\,\alpha$}
      \TrinaryInfC{$\Hom \,\alpha\,p: \Obj a = \Obj a$}
      \DisplayProof
    \hspace*{\fill}
    \\[1em]
    \hspace*{\fill}
      \AxiomC{$a : \N$}
      \AxiomC{$\alpha, \beta : B\,a ≃ B\,a$}
      \AxiomC{$p : P\,\alpha$}
      \AxiomC{$q : P\,\beta$}
      \QuaternaryInfC{$\Hom\,(\beta \circ \alpha)\, (\Op{Pcomp}\,p\,q) = \Hom \,\alpha\,p \bullet \Hom \,\beta\,q$}
      \DisplayProof
      \hspace*{\fill}
        \AxiomC{$\vphantom{X}$}
        \UnaryInfC{$\IsGpd \;\Op{U}_{A,B,P}$}
        \DisplayProof
    \hspace*{\fill}
  \end{center}
Above $\Op{Pcomp}$ is the closures of $P$ wrt.\@ composition of equivalences. It is possible to prove that $\Hom$ also preserves identities and inverses.
When $B$ is valued in sets, one can also define a function $\langle -\rangle : \Op{U}_{A,B,P} \to \Type$ extracting a set, so that $\langle \Obj a \rangle \DefEq B\,a$.
The polynomial functor $\Op{G}_{A,B,P}$ is %defined as
\[
\Op{G}_{A,B,P} X \DefEq \sum (x : \Op{U}_{A,B,P}) \Where \langle x \rangle \to X
\]
The latter can be related to $\Op{F}_{A,B,P}$ similarly to how $\Bag$ and $\FMSet$ are related via Theorems~\ref{thm:FMSetOfFMGpdTrunc} and \ref{prop:BagTote}: $\SetTrunc{\Op{G}_{A,B,P} X} \simeq \Op{F}_{A,B,P} X$. Since $\Op{G}_{A,B,P}$ is a polynomial functor, its final coalgebra can be constructed as an $\omega$-limit, as in Theorem \ref{thm:FMGpdLim}.
%% \begin{itemize}
%%     \item Hint at a definition of analytic functors using
%%         the above definitions (pick a subgroupoid of Bij etc.)
%%     \item Question:
%%         Does this definition \emph{weakly preserve pullbacks}?
%%         This would be the classical definition.
%% \end{itemize}

\section{Conclusions}

We looked at various definitions of the finite bag functor, valued in sets and in groupoids, and constructions of their final coalgebras. When working with set-based definitions, the set-theoretic constructions as $\omega$-limit of the chain in (\ref{eq:chain}) and as quotient of the final $\List$-coalgebra are not directly replicable in HoTT, since they imply the validity of classical principles like \LLPO{}. We are at least able to salvage the weak preservation of the $\omega$-limit of the chain in (\ref{eq:chain}). The situation is brighter when working with the groupoid-based definition. The latter is a polynomial functor, and as such has the final coalgebra given by the $\omega$-limit of the chain in (\ref{eq:chain}). We also briefly looked at
%an application of Cubical Agda's coinductive types for building the final coalgebra and
generalizations to other analytic functors, which we plan to further explore in the future.

Our conclusion is in line with the one of Kock~\cite{Kock2012} and Finster et al.~\cite{Finster2021}: the bag functor is better behaved when valued in groupoids instead of sets, especially from the perspective of final semantics. This seems to indicate that the denotational semantics of ``resource-sensitive'' computations %or dynamical systems
is better performed using groupoids instead of sets (switching from categorical to bicategorical semantics).
In particular, the syntax of process calculi such as CCS, or term calculi for linear logic,  could be defined directly as a groupoid, i.e. structural congruences could be treated as data instead of property. We plan to properly investigate this connection to programming language semantics in future work. For this endeavor, it will also be necessary to study the final coalgebra of combinations of the bag functor with other functors e.g.~formalizing the presence of labels or actions in the transition relation.

Cubical Agda currently allows the definition of coinductive types with HITs appearing in the codomain of destructors. For example, it is possible to define the following coinductive record:
\begin{equation}\label{eq:coind}
\def\arraystretch{0.8}
\begin{array}{l}
\Op{record} \; \cLim{\FCM} :  \Type \;\Op{where} \\
\quad  \Op{coinductive} \\
 \quad \Op{field} \\
 \quad \quad  \unfold : \FCM \cLim{\FCM}
\end{array}
\end{equation}
It is moreover possible to prove that this type is the final coalgebra of the set-based finite bag functor. The proof is similar to the one given for the finite powerset functor \cite[Theorem 2]{Veltri2021}. Definitions such as (\ref{eq:coind}) are an experimental feature of Cubical Agda, since the interaction of coinductive types and HITs has not yet been investigated (only for some M-types~\cite{Vezzosi2019}, which are definable internally in HoTT anyway). We believe that such definitions could be motivated by looking at recent work by Kristensen et al.~\cite{Kristensen2022}, which seems to indicate that the final coalgebra of functors such as $\FCM$ or $\Op{Pfin}$, which are given as HITs, should be definable as the \emph{strict} $\omega$-limit of the chain in (\ref{eq:chain}) in the cubical set model. Strictness means that the limit-property holds on the nose, not only up-to path equality.

%\nocite{*}

\bibliography{Multiset}
\end{document}
