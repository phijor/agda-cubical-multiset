% This is samplepaper.tex, a sample chapter demonstrating the
% LLNCS macro package for Springer Computer Science proceedings;
% Version 2.21 of 2022/01/12
%
\documentclass[runningheads]{llncs}
%
\usepackage[T1]{fontenc}
\usepackage{multiset}

\usepackage{bussproofs}

\usepackage{textcomp}

\usepackage{todonotes}

\begin{document}

\title{Final Coalgebra of the Finite Bag Functor}
\author{%
    Philipp Joram\inst{1}\orcidID{0000-0002-0448-7907} \and
    Niccolò Veltri\inst{1}\orcidID{0000-0002-7230-3436}%
}
%
\authorrunning{P. Joram et al.}
\institute{Department of Software Science, Tallinn University of Technology, Estonia}

\maketitle              % typeset the header of the contribution

\begin{abstract}
The abstract should briefly summarize the contents of the paper in
150--250 words.

\keywords{First keyword  \and Second keyword \and Another keyword.}
\end{abstract}

\section{Introduction}

\subsection{Notation}
\begin{itemize}
  \item Definitional equality: $\DefEq$
  \item propositional equality (paths): $=$
  \item Binders: always in the form of $\mathsf{Q} (x : X)\Where \langle\mathsf{expr}\rangle$,
    i.e. $\sum (n : \N)\Where n * n = 2$.
    Binders extend as far right as possible.
  \item $\exists$ for \emph{mere existence}, i.e. $\PropTrunc{\sum (\mathunderscore)\Where X}$.
  \item dependent paths: $\PathP{} (\lambda i\Where \mathunderscore)\, \mathunderscore\, \mathunderscore$
\end{itemize}

\section{Type Theory and Cubical Agda}

\section{The Finite Bag Functor}

The action of the bag functor on a type $X$ can be encoded as higher inductive
types in various ways, two of which we present here.
The first is as the type of lists set-quotiented by an \emph{up to permutation}-relation,
the second being the free commutative monoid on $X$.


\subsection{As a HIT}

Given a type $X$, the free commutative monoid $(\M X, \Union, \Empty)$ is
defined as the higher inductive type induced by the following rules:
\begin{itemize}
  \item Point constructors:
    \begin{center}
      \hspace*{\fill}
        \AxiomC{$\vphantom{X}$}
        \UnaryInfC{$\Empty : \M{X}$}
        \DisplayProof
      \hfill
        \AxiomC{$x : X$}
        \UnaryInfC{$\Singl x : \M X$}
        \DisplayProof
      \hfill
        \hspace{10pt}
        \AxiomC{$xs, ys : \M X$}
        \UnaryInfC{$\Var{xs} \Union \Var{ys} : \M X$}
        \DisplayProof
      \hspace*{\fill}
    \end{center}
  \item Monoid axioms and commutativity:
    \begin{center}
      \hspace*{\fill}
        \AxiomC{$\Var{xs} : \M X$}
        \UnaryInfC{$\mathsf{unit} : \Empty \Union \Var{xs} = \Var{xs}$}
        \DisplayProof
      \hfill
        \AxiomC{$\Var{xs}, \Var{ys}, \Var{xs} : \M X$}
        \UnaryInfC{
          $\mathsf{assoc} : \Var{xs}\Union(\Var{ys}\Union\Var{zs}) = (\Var{xs}\Union\Var{ys})\Union\Var{zs}$
        }
        \DisplayProof
      \hspace*{\fill}
      \\[6pt]
      \hspace*{\fill}
        \AxiomC{$\Var{xs}, \Var{ys} : \M X$}
        \UnaryInfC{
          $\mathsf{comm} : \Var{xs}\Union\Var{ys} = \Var{ys}\Union\Var{xs}$
        }
        \DisplayProof
      \hspace*{\fill}
    \end{center}
  \item set truncation:
    \begin{center}
      \hspace*{\fill}
        \AxiomC{$\Var{xs}, \Var{ys} : \M X$}
        \AxiomC{$p, q : \Var{xs} = \Var{ys}$}
        \BinaryInfC{
          $\mathsf{trunc} : p = q$
        }
        \DisplayProof
      \hspace*{\fill}
    \end{center}
\end{itemize}

\subsection{As a Set Quotient}

\begin{definition}
  The type of finite multisets over a type $X$ is the type
  \begin{align*}
    \FMSet X
      \mathbin{=_{\mathrm{df}}}
      \sum\,\Var{sz} : ℕ\Where
        (\Fin \Var{sz} \to X) \mathbin{/_{\!2}} \mathrel{\sim},
  \end{align*}
  where $\sim$ is the proposition-valued relation defined as
  \begin{align*}
    \textunderscore\sim\textunderscore &: ∀ \{n\}\Where (v\, w : \Fin n → X) → \Type \\
    v \sim w &\mathrel{=_{\mathsf{df}}}
      ∃ \sigma : \Fin n ≃ \Fin n \Where
        \PathP{} (\lambda i\Where \operatorname{ua}(\sigma)\, i → X)\, v\, w
  \end{align*}
\end{definition}

\begin{definition}
  The recursion principle for $\FMSet X$ is the function
  \begin{align*}
    \Rec{\FMSet}
      &: \{A : \Type\} → \IsSet{A} \\
      &→ (\Op{as} : \{n : ℕ\} → (v : \Fin n → X) → A) \\
      &→ (∀ n\Where (v, w : \Fin n → X) → v \sim_n w → \Op{as} v = \Op{as} w) \\
      &→ \FMSet X → A
  \end{align*}
  defined from the recursion principle of set-quotients.
  Similarly, we define the induction principle $\Op{elim}_{\FMSet}$ for
  a dependent type family $B : \FMSet X → \Type$ of sets.
\end{definition}

\subsubsection{Finite Choice for Sets}

\begin{lemma}
  Set truncation distributes over finite families of types.
  For any $n : ℕ$ and type family $Y : \Fin n \to \Type$,
  there is an equivalence
  \[
    \Op{box} :
    ((k : \Fin n) → \SetTrunc{\mathop{Y\/} k})
    ≃
    {\SetTrunc{(k : \Fin n) → \mathop{Y\/} k}}
  \]
\end{lemma}

\begin{definition}
  The principle of finite choice can be defined in terms of $\Op{box}$:
  \begin{align*}
    \Op{elim}_{\Op{fin}} &: \forall n\Where \\
      &\to \{B : (\Fin n \to \SetTrunc{X}) \to \Type\} \\
      &\to (\forall v\Where \IsSet (B\, v)) \\
      &\to ((\mathsf{choice} : \Fin n \to X) \to B\, (\SetTruncCon{} \circ \mathsf{choice})) \\
      &\to (v : \Fin n \to \SetTrunc{X}) \to B\, v)
  \end{align*}
  It is defined by applying $\mathsf{choice}$ to the term obtained from
  set-truncation elimination on $\operatorname{box} v$.
  It comes with a computational rule
  \begin{align*}
    \Op{elim}^\beta_{\Op{fin}} : (v : \Fin n → X)
      → \Op{elim}_{\Op{fin}} (\SetTruncCon{} \circ v) = \operatorname{\mathsf{choice}} v
  \end{align*}
\end{definition}

\begin{theorem}\label{thm:FMSetSetTruncInvariant}
  Finite multisets are invariant under set-truncation:
  \begin{equation}
    \FMSet \SetTrunc{X} ≃ \FMSet X
  \end{equation}
\end{theorem}
\begin{proof}
  \begin{enumerate}
    \item Inverse is given by $\operatorname{map} \SetTruncCon{} : \FMSet X → \FMSet \SetTrunc{X}$.
    \item Define the inverse by using
      \[
        \Op{requot} : ∀ \{n\}\Where
          (\Fin n → \SetTrunc{X})
          → (\Fin n → X) \SetQuot{} {\sim_n},
      \]
      defined via $\Op{elim}_{\Op{fin}}$.
  \end{enumerate}
\end{proof}

\subsection{As a Groupoid}
Following \cite{Kock2012}, we argue the correct perspective on bags in Homotopy Type Theory
is to define them as groupoids instead of sets.
The rationale is that identifications of bags are permutations, and these should inherently be treated as \emph{data}.
Instead of viewing bags as quotients of lists, thereby \enquote{forgetting} about the permutations,
we define a type of lists with \enquote{more identifications}.
Since all constructions based on this type have to be homotopy coherent,
they will automatically respect these extra data,
making them invariant under permutation for free.
We define a type family $\Bag : \Type → \Type$,
and substantiate these claims by first showing its set-truncation is $\FMSet$ (\cref{thm:FMSetOfFMGpdTrunc}),
and later by constructing its final coalgebra (\cref{ssec:FMGpdLim}, \cref{thm:FMGpdLim}).

First, recall one way of defining \enquote{finite} sets in HoTT:

\begin{definition}
  A type $Y$ is called \emph{(Bishop-) finite} if
  \[
    \Op{isFinSet} Y \DefEq
      \sum (n : ℕ)\Where \PropTrunc{Y ≃ \Fin n}
  \]
  holds,
  and we denote the collection of such types by
  \[
    \Op{FinSet} \DefEq
      \sum (Y : \Type)\Where \Op{isFinSet} Y
  \]
\end{definition}

It is easy to show that $\Op{isFinSet}$ is a proposition and that any type satisfying the predicate is a set.
Similarly, one shows that $\Op{FinSet}$ forms a groupoid.
Note that $\Op{FinSet}$ is a \emph{large} type, i.e. it lives in the successor universe of the types that it ranges over.
From this, we can define a \enquote{tote}, which we think of as a finite collections of things in $X$:
\begin{definition}
  A large type, $\Tote : \Type_\ell → \Type_{\ell + 1}$:
  \begin{align*}
    \Tote X
      \mathbin{=_{\mathrm{df}}}
      \sum\,\Var{B} : \operatorname{FinSet}\Where B \to X,
  \end{align*}
\end{definition}

In general, $\Tote X$ is at least a groupoid.

\begin{proposition}
  If $X$ is a groupoid, then $\Tote X$ is a groupoid.
\end{proposition}
\begin{proof}
  By assumption $X$ is a groupoid,
  so the function type $\langle Y \rangle → X$ is a groupoid
  for any $Y : \FinSet$.
  By construction $\Bij$ is a groupoid, therefore the entire $\Sigma$-type is a groupoid.
\end{proof}

Note that $\Tote$ is again a large type family.
This makes it unsuitable for iteration, as the assignment $(\lambda n\Where \Tote^n \mathsf{1})$
of $n$-fold applications of the family is not typeable in a universe of bounded size.
We will later\todo{\cref{def:Bag}} introduce an equivalent, small family $\Bag$ that avoids this issue, following \cite{Finster2021}.

\todo[inline]{%
  Relating $\Tote$ back to finite multisets:
}

\begin{theorem}\label{thm:FMSetOfFMGpdTrunc}
  Set-truncating a tote yields a finite multiset.
  For any type $X$,
  \[
    \SetTrunc{\Tote X} ≃ \FMSet X
  \]
\end{theorem}
\begin{proof}
  The proof proceeds by constructing an explicit isomorphism $\FMSet X \cong \SetTrunc{\Tote X}$.
  The forward function is straight forward, while the inverse function has to be carefully defined with the
  homotopy levels of the involved types in mind.

  \newcommand*{\ToTote}{\operatorname{\mathsf{toTote}}}

  To construct the map $\FMSet X → \SetTrunc{\Tote X}$, by the induction principle
  $\Elim{\FMSet}$, it is enough to give a function
  $f : \forall \{\Var{sz}\}\Where (\Fin \Var{sz} → X) → \SetTrunc{\Tote X}$
  and to show that it respects $(\sim)$.
  Let $f(v) \DefEq \SetTruncCon[(\Fin \Var{sz} , v)]$, since $\Fin \Var{sz}$ is obviously a finite set.
  To prove that $v \sim w$ implies $f(v) = f(w)$, we note that the conclusion is a proposition,
  thus by induction on $v \sim w$ obtain a permutation $\sigma$ such that $r : v \circ \sigma = w$.
  We conclude that
  \[
    p \DefEq
      \operatorname{\mathsf{\Sigma PathP}}\, (\mathsf{ua}\, \sigma)\, r : (\Fin\Var{sz} , v) = (\Fin\Var{sz}, w),
  \]
  which implies $f(v) = f(w)$ by applying $\SetTruncCon$ to $p$.

  To define the inverse $\SetTrunc{\Tote X} → \FMSet X$,
  by set-truncation elimination it is enough to provide
  \begin{align*}
    g : \Tote{X} &→ \FMSet X \\
    g\, (Y, \Var{sz}, e, v) &\DefEq (\Var{sz} , g')
  \end{align*}
  where $Y$ is a finite set of size $\Var{sz}$ with $e : \PropTrunc{Y ≃ \Fin\Var{sz}}$ and $v : Y → X$.
  We would like to use a composition $\Fin\Var{sz} → Y → X$ to find
  $g' : \SetQuot[(\Fin\Var{sz} → X)][\mathord{\sim}]$,
  but one cannot do so because $e$ is propositionally truncated.
  Using induction directly on $e$ cannot work, since $g'$ lives in a set.
  We can however show that
  \begin{align*}
    &\operatorname{\mathsf{from-equiv}} : (Y ≃ \Fin\Var{sz}) → \SetQuot[(\Fin\Var{sz} → X)][\mathord{\sim}] \\
    &\operatorname{\mathsf{from-equiv}} \alpha \DefEq \SetQuotCon[v \circ \alpha]
  \end{align*}
  is \emph{weakly-constant} in the sense of \cite{Kraus2017} to obtain $g'$ from $e$ using the elimination
  principle of \cite[{Corollary~2}]{Capriotti2015}.

  Proving that $g$ is a right-inverse of $f$ is straight forward.
  Proving that it is a left-inverse reduces to showing that $v \circ \alpha \sim v$ for any $v : Y → X$ and $\alpha : \Fin n ≃ Y$.
\end{proof}

\begin{definition}\label{def:Bag}
  A small type:
  \begin{align*}
    \Bag X
      \mathbin{=_{\mathrm{df}}}
      \sum\,\Var{x} : \operatorname{\mathsf{Bij}}\Where
        \langle x \rangle \to X,
  \end{align*}
  We abbreviate ${\lbag v \rbag} \DefEq (x, v) : \Bag X$ if $x$ can be inferred from context.
\end{definition}

\paragraph{Comparing $\Op{List}$ and $\Bag$}\todo{Fit this comparison in somewhere}
Note that $\Bag$ is somewhat analogous to $\Op{List}$:
Given a type $A$ and a family $B$ over it, they both match ${\sum (a : A)\Where B(a) → X}$:
we have $A = ℕ$ and $B = \Fin$ for $\Op{List}$,
and $A = \Bij$ and $B = \langle\_\rangle$ for $\Bag$.
In particular, $\SetTrunc{\Bij} ≃ ℕ$.

\subsection{As lists up to permutation}

\begin{theorem}
  For any $X$, the types $\FMSet X$, $\M X$ and $\operatorname{PList} X$ are equivalent.
\end{theorem}

\section{The Final Coalgebra}

Describe limits in general.
Maybe compare final coalgebras and corecursive algebras which are fixpoints.

\subsection{Final Coalgebras as an $\omega$-Limit in Set}

\todo[inline]{%
    Surjectivity works (under the assumption of countable(?) choice).
}

  \begin{theorem}\label{thm:InjPresImpliesLLPO}
    The function 
        $\operatorname{pres}\colon
            \FMSet (\lim_{n < \omega} \FMSet^n 1)
            \to
            \lim_{n < \omega} (\FMSet^{n+1} 1)$
    is surjective,
    but its injectivity implies the \emph{lesser limited principle of omniscience}, \LLPO.
  \end{theorem}

\todo[inline]{%
    Think about the converse statement,
    does {\LLPO} already imply injectivity?
}

\subsection{Final Coalgebras as an $\omega$-Limit in Groupoids}\label{ssec:FMGpdLim}

\begin{theorem}\label{thm:FMGpdLim}
  Let $L_{\Bag} \DefEq \lim_{n < \omega} \Bag^n 1$.
  The limit-preservation map $\operatorname{pres}$ is an equivalence of groupoids.
  In particular, the limit $L_{\Bag}$ is a fixpoint of $\Bag$ and its final coalgebra.
\end{theorem}

\subsection{Truncating the Groupoid Construction}

Compare the set-truncation of the groupoid construction
and the set-level definition.

\begin{theorem}\label{thm:FMSetFixpointOfTrunc}
  The set-truncation of $\Lim{\Bag}$ is a fixpoint of $\FMSet$, i.e.\@
  there is an equivalence $\FMSet \SetTrunc{\Lim{\Bag}} ≃ \SetTrunc{\Lim{\Bag}}$.
\end{theorem}
\begin{proof}
  The equivalence is obtained from the composition
  \begin{align}
    \FMSet \SetTrunc{\Lim{\Bag}}
      &≃ \FMSet \Lim{\Bag}          \Step{thm:FMSetFixpointOfTrunc:step1} \\
      &≃ \SetTrunc{\Bag \Lim{\Bag}} \Step{thm:FMSetFixpointOfTrunc:step2} \\
      &≃ \SetTrunc{\Lim{\Bag}}      \Step{thm:FMSetFixpointOfTrunc:step3}
  \end{align}
  where \eqref{thm:FMSetFixpointOfTrunc:step1} is invariance of $\FMSet$ under set-truncation
  (\cref{thm:FMSetSetTruncInvariant}),
  \cref{thm:FMSetFixpointOfTrunc:step2} is \cref{thm:FMSetOfFMGpdTrunc}
  and \eqref{thm:FMSetFixpointOfTrunc:step3} follows since $\Lim{\Bag}$ is a limit (\cref{thm:FMGpdLim}).
\end{proof}

Note that the above fixpoint is not necessarily the \emph{largest} fixpoint.
\todo[inline,caption={Choice for largest fixpoint}]{%
  \emph{(Unproven)}
  Only assuming the (full) axiom of choice this is the case, i.e.\@ yields a final coalgebra.
  }

\section{Discussion: Alternatives}
\subsection{Outlook: Generalization to Analytic Functors}

\begin{itemize}
    \item Hint at a definition of analytic functors using
        the above definitions (pick a subgroupoid of Bij etc.)
    \item Question:
        Does this definition \emph{weakly preserve pullbacks}?
        This would be the classical definition.
\end{itemize}

\subsection{Using Coinductive Types?}

\begin{itemize}
    \item It is not clear that Agda's coinductive types
        interacts well with HITs.
    \item This might not work with the groupoid-definition:
        Either we use HITs (possibly inconsistent, for the small Bij),
        or the construction ends up being too large.
    \item
        Another approach: Quotient the (entire) final coalgebra of lists.
\end{itemize}

\section{Conclusions}

\subsubsection{Acknowledgements}

\nocite{*}

\bibliographystyle{splncs04}
\bibliography{Multiset}
\end{document}
